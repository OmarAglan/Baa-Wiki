name: ๐ Sync Documentation from Main Repository

on:
  schedule:
    # Run every 6 hours to sync docs
    - cron: '0 */6 * * *'
  
  workflow_dispatch:
    # Allow manual triggering
    
  repository_dispatch:
    # Triggered by main Baa repository when docs are updated
    types: [docs-updated]

jobs:
  sync-docs:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      pages: write
      id-token: write
    
    steps:
      - name: ๐ Checkout baa-wiki repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: ๐๏ธ Remove old documentation
        run: |
          if [ -d "docs" ]; then
            rm -rf docs/
            echo "Removed existing docs directory"
          else
            echo "No existing docs directory found"
          fi

      - name: ๐ฅ Clone main Baa repository
        run: |
          echo "Cloning main Baa repository..."
          git clone --depth=1 https://github.com/OmarAglan/Baa.git temp-baa
          
          if [ -d "temp-baa/docs" ]; then
            cp -r temp-baa/docs ./docs
            echo "โ Successfully copied docs from main repository"
            ls -la docs/
          else
            echo "โ No docs directory found in main repository"
            mkdir -p docs
            echo "# Documentation" > docs/index.md
            echo "Documentation will be synced from the main repository." >> docs/index.md
          fi
          
          rm -rf temp-baa

      - name: ๐ง Process Arabic-first structure
        run: |
          # Create processing script if it doesn't exist
          mkdir -p .vitepress/scripts
          cat > .vitepress/scripts/process-docs.js << 'EOF'
          const fs = require('fs');
          const path = require('path');

          function processDocsStructure() {
            const docsDir = './docs';
            
            if (!fs.existsSync(docsDir)) {
              console.log('No docs directory found');
              return;
            }

            // Create index.md if it doesn't exist
            const indexPath = path.join(docsDir, 'index.md');
            if (!fs.existsSync(indexPath)) {
              const indexContent = `---
          home: true
          title: ูุบุฉ ุจุงุก - Baa Programming Language
          titleTemplate: false

          hero:
            name: ูุบุฉ ุจุงุก
            text: ูุบุฉ ุจุฑูุฌุฉ ุนุฑุจูุฉ ุญุฏูุซุฉ
            tagline: Modern Arabic Programming Language
            image:
              src: /logo.svg
              alt: Baa Language Logo
            actions:
              - theme: brand
                text: ุงูุจุฏุงูุฉ ุงูุณุฑูุนุฉ
                link: /00_ูุธุฑุฉ_ุนุงูุฉ/ุงูุจุฏุงูุฉ_ุงูุณุฑูุนุฉ
              - theme: alt
                text: ูุดุงูุฏุฉ ุนูู GitHub
                link: https://github.com/OmarAglan/Baa

          features:
            - icon: ๐๏ธ
              title: ุนุฑุจูุฉ ุจุงููุงูู
              details: ูุบุฉ ุจุฑูุฌุฉ ูุตููุฉ ุฎุตูุตุงู ูููุทูุฑูู ุงูุนุฑุจ ุจูุญู ุนุฑุจู ุทุจูุนู
            - icon: โก
              title: ุญุฏูุซุฉ ูุณุฑูุนุฉ
              details: ุชุฌูุน ุจูู ุจุณุงุทุฉ Python ูููุฉ Rust ูุน ุฏุนู ููุจุฑูุฌุฉ ุงููุชูุงุฒูุฉ
            - icon: ๐ง
              title: ุฃุฏูุงุช ูุชุทูุฑุฉ
              details: ูุญุฑุฑ ูุฏูุฌุ ูุฏูุฑ ุญุฒูุ ููุธุงู ุจูุงุก ูุชูุฏู
          ---

          # ุฃููุงู ูุณููุงู ูู ูุบุฉ ุจุงุก

          **ูุบุฉ ุจุงุก** ูู ูุบุฉ ุจุฑูุฌุฉ ุนุฑุจูุฉ ุญุฏูุซุฉ ูุตููุฉ ูุชููู ุจุฏููุงู ุทุจูุนูุงู ููููุงู ูููุทูุฑูู ุงูุนุฑุจ.

          ## โจ ููุงุฐุง ูุบุฉ ุจุงุกุ

          - **๐ ุนุฑุจูุฉ ุจุงููุงูู**: ูุชุงุจุฉ ุงูููุฏ ุจุงูุนุฑุจูุฉ ุจุดูู ุทุจูุนู ููุฃููู
          - **๐ ุฃุฏุงุก ุนุงูู**: ูุชุฑุฌู ูุญุณูู ูุฅูุชุงุฌ ููุฏ ุณุฑูุน ููุนูุงู  
          - **๐๏ธ ุฃุฏูุงุช ุดุงููุฉ**: ุจูุฆุฉ ุชุทููุฑ ูุชูุงููุฉ ูุน ุฌููุน ุงูุฃุฏูุงุช ุงููุทููุจุฉ
          - **๐ ุชูุซูู ุซุฑู**: ุฏููู ุดุงูู ุจุงููุบุฉ ุงูุนุฑุจูุฉ ูุน ุฃูุซูุฉ ุนูููุฉ

          ## ๐ ุงุจุฏุฃ ุงูุขู

          \`\`\`bash
          # ุชุซุจูุช ูุบุฉ ุจุงุก
          curl -sSf https://get.baa-lang.org | sh

          # ุฅูุดุงุก ูุดุฑูุน ุฌุฏูุฏ
          ุจุงุก ุฌุฏูุฏ ูุดุฑูุนู
          cd ูุดุฑูุนู

          # ุชุดุบูู ุงููุดุฑูุน
          ุจุงุก ุชุดุบูู
          \`\`\`

          ## ๐ ุชุนููู ุงููุฒูุฏ

          - [ุงูุจุฏุงูุฉ ุงูุณุฑูุนุฉ](/00_ูุธุฑุฉ_ุนุงูุฉ/ุงูุจุฏุงูุฉ_ุงูุณุฑูุนุฉ) - ุงุจุฏุฃ ุฑุญูุชู ูุน ูุบุฉ ุจุงุก
          - [ููุงุตูุงุช ุงููุบุฉ](/01_ููุงุตูุงุช_ุงููุบุฉ/) - ุชุนุฑูู ุนูู ููุงุนุฏ ูููุงููู ุงููุบุฉ
          - [ุฃูุซูุฉ ุนูููุฉ](/04_ุฃูุซูุฉ_ูุชุทุจููุงุช/) - ุงูุชุดู ููุฉ ูุบุฉ ุจุงุก ูู ุฎูุงู ุงูุฃูุซูุฉ

          ---

          <div style="text-align: center; margin-top: 2rem; padding: 1rem; background: var(--vp-c-bg-soft); border-radius: 8px;">
            <p>๐ก <strong>ูุตูุญุฉ:</strong> ุงุจุฏุฃ ุจูุฑุงุกุฉ <a href="/00_ูุธุฑุฉ_ุนุงูุฉ/ุงูุจุฏุงูุฉ_ุงูุณุฑูุนุฉ">ุงูุจุฏุงูุฉ ุงูุณุฑูุนุฉ</a> ูููู ุฃุณุงุณูุงุช ูุบุฉ ุจุงุก ูู ุฏูุงุฆู ูุนุฏูุฏุฉ</p>
          </div>
          `;
              
              fs.writeFileSync(indexPath, indexContent);
              console.log('โ Created index.md');
            }

            console.log('๐ Documentation structure processed successfully');
          }

          processDocsStructure();
          EOF

          node .vitepress/scripts/process-docs.js

      - name: ๐ Commit and push changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add docs/
          
          if git diff --staged --quiet; then
            echo "๐ No changes to commit"
          else
            git commit -m "๐ Auto-sync docs from main repository

            Synced documentation from: https://github.com/OmarAglan/Baa
            Timestamp: $(date -u +'%Y-%m-%d %H:%M:%S UTC')
            Triggered by: ${{ github.event_name }}"
            
            git push
            echo "โ Successfully pushed documentation updates"
          fi

      - name: ๐๏ธ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: ๐ฆ Install dependencies
        run: |
          echo "Installing VitePress and dependencies..."
          npm ci

      - name: ๐๏ธ Build documentation site
        run: |
          echo "Building documentation with VitePress..."
          npm run build
          
          # Verify build output
          if [ -d ".vitepress/dist" ]; then
            echo "โ Build successful"
            ls -la .vitepress/dist/
          else
            echo "โ Build failed - no dist directory found"
            exit 1
          fi

      - name: ๐ค Upload build artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: .vitepress/dist

      - name: ๐ Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
        
      - name: ๐ Summary
        run: |
          echo "## ๐ Documentation Sync Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "โ Documentation synced from main repository" >> $GITHUB_STEP_SUMMARY
          echo "โ Site built successfully with VitePress" >> $GITHUB_STEP_SUMMARY
          echo "โ Deployed to GitHub Pages" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "๐ **Live site:** ${{ steps.deployment.outputs.page_url }}" >> $GITHUB_STEP_SUMMARY
          echo "๐ **Last sync:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
