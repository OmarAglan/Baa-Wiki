# توثيق هيكل المحلل النحوي للغة باء (التصميم الجديد v2)

**متاح باللغة:** [العربية](#) | [English](../02_COMPILER_ARCHITECTURE/PARSER.md)

**الحالة: هذا المستند يحدد التصميم المنقح للمحلل النحوي. العناصر هنا مخططة إلى حد كبير ما لم يُذكر خلاف ذلك. هذا المحلل النحوي سيولد شجرة نحو مجردة (AST) تتوافق مع تصميم `AST.md` الجديد (v2).**

يوفر هذا المستند مرجعاً شاملاً لتنفيذ المحلل النحوي في مترجم لغة برمجة باء. دور المحلل النحوي هو تحويل تسلسلات الرموز المميزة التي ينتجها المحلل اللفظي إلى شجرة نحو مجردة (AST)، وتحديداً شجرة من هياكل `BaaNode`.

## ١. مبادئ التصميم الأساسية

1. **التقسيم النمطي**: المحلل النحوي منظم في وحدات/ملفات منطقية لتركيبات لغوية مختلفة (مثل `expression_parser.c`، `statement_parser.c`، `declaration_parser.c`، `type_parser.c`).
2. **نهج الهبوط التكراري**: يستخدم المحلل النحوي تقنية تحليل نحوي تنبؤية من أعلى إلى أسفل بالهبوط التكراري. كل غير طرفي مهم في قواعد لغة باء سيتوافق عادةً مع دالة تحليل نحوي تُرجع `BaaNode*`.
3. **التركيز النحوي وبناء AST**:
    * المحلل النحوي مسؤول بشكل صارم عن التحقق النحوي وفقاً لقواعد لغة باء.
    * عند التعرف الناجح على قاعدة نحوية، يبني `BaaNode` المناسب (بما في ذلك هيكل `data` المحدد) باستخدام دوال إنشاء AST (مثل `baa_ast_new_binary_expr_node(...)`).
    * الفحوصات الدلالية (مثل فحص النوع، حل النطاق) يتم تأجيلها إلى مرحلة التحليل الدلالي اللاحقة.
4. **معالجة الأخطاء والاستقبال**: اكتشاف الأخطاء القوي، والإبلاغ (مع `BaaSourceSpan` دقيق)، وآلية استقبال محددة (وضع الذعر مع التزامن) متكاملة.

## ٢. معمارية المحلل النحوي

حالة المحلل النحوي والمنطق الأساسي يقيمان في `parser.c`، مع دوال تحليل نحوي متخصصة في وحدات منفصلة:

```
BaaParser (المحلل النحوي الرئيسي - parser.c)
├── محلل التعبيرات (expression_parser.c)
├── محلل العبارات (statement_parser.c)
├── محلل الإعلانات (declaration_parser.c)
├── محلل الأنواع (type_parser.c)
└── أدوات المحلل النحوي (parser_utils.c - استهلاك الرموز، إبلاغ الأخطاء، إلخ.)
```

كل دالة تحليل نحوي (مثل `parse_if_statement`، `parse_binary_expression`) ستُرجع `BaaNode*` يمثل التركيب المُحلل، أو `NULL` إذا حدث خطأ نحوي لا يمكن استقباله لذلك التركيب.

## ٣. حالة المحلل النحوي

المحلل النحوي يحافظ على حالته في هيكل `BaaParser`:

```c
typedef struct {
    BaaLexer* lexer;           // مؤشر إلى نسخة المحلل اللفظي التي توفر الرموز المميزة
    BaaToken current_token;    // الرمز المميز الحالي قيد المعالجة (النظرة المسبقة)
    BaaToken previous_token;   // الرمز المميز المستهلك مؤخراً (مفيد لنطاق المصدر)
    const char* source_filename; // اسم الملف المصدر قيد التحليل (لرسائل الخطأ)
    bool had_error;            // علم: صحيح إذا تم مواجهة أي خطأ نحوي
    bool panic_mode;           // علم: صحيح إذا كان المحلل النحوي يستقبل حالياً من خطأ
} BaaParser;
```

## ٤. عملية التحليل النحوي ومسؤوليات الدوال الرئيسية

### ٤.١ المحلل النحوي الرئيسي (`parser.c`, `parser.h`)

* **`BaaParser* baa_parser_create(BaaLexer* lexer, const char* source_filename)`**: يُهيئ محلل نحوي جديد.
* **`void baa_parser_free(BaaParser* parser)`**: يحرر موارد المحلل النحوي.
* **`BaaNode* baa_parse_program(BaaParser* parser)`**: نقطة الدخول. يحلل تسلسل من الإعلانات على المستوى الأعلى حتى `BAA_TOKEN_EOF`. يُرجع `BaaNode*` من النوع `BAA_NODE_KIND_PROGRAM`.

### ٤.٢ محلل الإعلانات (`declaration_parser.c`)

* **`BaaNode* parse_declaration_or_statement(BaaParser* parser)`**: ✅ **مُنفذ** - موزع ذكي يميز بين تعريفات الدوال، إعلانات المتغيرات، والعبارات باستخدام منطق النظرة المسبقة.
* **`BaaNode* parse_function_definition(BaaParser* parser, BaaAstNodeModifiers initial_modifiers)`**: ✅ **مُنفذ** - يحلل تعريفات الدوال الكاملة مع نوع الإرجاع، الاسم، المعاملات، والجسم.
  * **معاملات الدوال**: يستخدم `parse_parameter_list()` لتحليل قوائم المعاملات المفصولة بفواصل
  * **دعم الصيغة**: `[modifiers] return_type function_name(parameter_list) { body }`
  * **مثال عربي**: `عدد_صحيح جمع(عدد_صحيح أ، عدد_صحيح ب) { إرجع أ + ب؛ }`

### ٤.٣ محلل الأنواع (`type_parser.c`)

* **`BaaNode* parse_type_specifier(BaaParser* parser)`**: يحلل مواصفة نوع من تدفق الرموز المميزة (مثل `عدد_صحيح`، `حرف[]`، `مؤشر<نوع>`).
  * يُرجع `BaaNode*` من النوع `BAA_NODE_KIND_TYPE`.

### ٤.٤ محلل العبارات (`statement_parser.c`)

* **`BaaNode* parse_statement(BaaParser* parser)`**: يوزع بناءً على الرمز المميز الحالي (`إذا`، `طالما`، `{`، بداية التعبير، إلخ.).
* **`BaaNode* parse_block_statement(BaaParser* parser)`**: يحلل `{ statement* }`. يُرجع `BaaNode*` من النوع `BAA_NODE_KIND_BLOCK_STMT`.
* **`BaaNode* parse_if_statement(BaaParser* parser)`**: يحلل `إذا (condition) then_branch (وإلا else_branch)?`. يُرجع `BaaNode*` من النوع `BAA_NODE_KIND_IF_STMT`.

### ٤.٥ محلل التعبيرات (`expression_parser.c`)

* **`BaaNode* parse_expression(BaaParser* parser)`**: نقطة الدخول لتحليل أي تعبير. عادة يبدأ باستدعاء مستوى الأولوية الأقل.
* **تسلق الأولوية باستخدام الدوال المتتالية:**
  * `BaaNode* parse_assignment_expression(BaaParser* parser)` (يتعامل مع `=`، `+=`، إلخ.)
  * `BaaNode* parse_logical_or_expression(BaaParser* parser)` (يتعامل مع `||`)
  * `BaaNode* parse_logical_and_expression(BaaParser* parser)` (يتعامل مع `&&`)
  * ... (مستويات للبتوايز، المساواة، العلائقية، التحويل، الجمعية، الضربية) ...
  * `BaaNode* parse_unary_expression(BaaParser* parser)` (يتعامل مع `!`، `-` (أحادي)، `~`، `++` (بادئة)، `--` (بادئة))
  * `BaaNode* parse_postfix_expression(BaaParser* parser, BaaNode* base_expr)` ✅ **مُنفذ** - يتعامل مع استدعاءات الدوال `()`، فهرسة المصفوفات `[]`، `++` (لاحقة)، `--` (لاحقة)
  * `BaaNode* parse_call_expression(BaaParser* parser, BaaNode* callee_expr)` ✅ **مُنفذ** - يحلل تعبيرات استدعاء الدوال مع قوائم الوسائط
  * `BaaNode* parse_primary_expression(BaaParser* parser)`: يحلل القيم الحرفية، المعرفات، `( expression )`.

### ٤.٦ دعم الدوال (✅ مكتمل - الأولوية ٤)

المحلل النحوي الآن لديه دعم شامل لتعريفات الدوال وتعبيرات استدعاء الدوال:

#### تعريفات الدوال
* **الصيغة**: `[modifiers] return_type function_name(parameter_list) { body }`
* **مثال عربي**: `عدد_صحيح جمع(عدد_صحيح أ، عدد_صحيح ب) { إرجع أ + ب؛ }`
* **عقدة AST**: `BAA_NODE_KIND_FUNCTION_DEF` مع `BaaFunctionDefData`
* **الميزات**:
  - قوائم المعاملات مع تحليل النوع والاسم
  - تحديد نوع الإرجاع
  - جسم الدالة كعبارة كتلة
  - دعم المعدلات (const، inline، إلخ.)
  - دعم قائمة المعاملات الفارغة: `void function_name() { ... }`

#### معاملات الدوال
* **الصيغة**: `type_specifier identifier`
* **عقدة AST**: `BAA_NODE_KIND_PARAMETER` مع `BaaParameterData`
* **الميزات**:
  - إعلانات معاملات آمنة النوع
  - دعم معاملات متعددة مع فصل بالفواصل
  - معالجة أخطاء مناسبة للمعاملات المشوهة

#### تعبيرات استدعاء الدوال
* **الصيغة**: `function_name(argument_list)`
* **مثال عربي**: `نتيجة = جمع(٥، ١٠)؛`
* **عقدة AST**: `BAA_NODE_KIND_CALL_EXPR` مع `BaaCallExprData`
* **الميزات**:
  - تحليل قائمة الوسائط مع فصل بالفواصل
  - دعم قائمة الوسائط الفارغة: `function_name()`
  - استدعاءات دوال متداخلة: `outer(inner(x), y)`
  - أولوية مناسبة كتعبيرات لاحقة

## ٥. معالجة الأخطاء والاستقبال

المحلل النحوي سيستخدم استراتيجية استقبال أخطاء "وضع الذعر":

1. **الاكتشاف**: عندما يتم العثور على رمز مميز غير متوقع، يتم اكتشاف خطأ.
2. **الإبلاغ (`parser_error(BaaParser* p, const wchar_t* message_format, ...)`):**
    * يضع `p->had_error = true`.
    * يطبع رسالة خطأ معلوماتية (بالعربية) باستخدام موقع الرمز المميز.
    * يتجنب التقارير المتتالية إذا كان بالفعل في `panic_mode`.
3. **تفعيل وضع الذعر**: `p->panic_mode = true`. لا يتم إنشاء عقد AST للتركيب الخاطئ.
4. **التزامن (`synchronize(BaaParser* p)`):**
    * يُستدعى بعد الإبلاغ عن خطأ.
    * يتجاهل الرموز المميزة حتى الوصول إلى نقطة "آمنة" أو EOF.
    * **نقاط التزامن:**
        * منهي العبارة (`.`).
        * الكلمات المفتاحية التي تبدأ بشكل موثوق عبارة أو إعلان جديد (مثل `إذا`، `طالما`، `لكل`، `إرجع`، إلخ.).
        * قوس الفتح `{` (غالباً يبدأ كتلة/نطاق جديد).
        * قوس الإغلاق `}` (غالباً ينهي كتلة، ابحث عن العبارة التالية).
5. **إلغاء تفعيل وضع الذعر**: بمجرد التزامن، يتم مسح `p->panic_mode`.

## ٦. واجهة برمجة التطبيقات العامة

```c
#ifndef BAA_PARSER_H
#define BAA_PARSER_H

#include "baa/lexer/lexer.h" // لـ BaaLexer, BaaToken
#include "baa/ast/ast.h"     // لـ BaaNode

typedef struct BaaParser BaaParser; // هيكل غامض

BaaParser* baa_parser_create(BaaLexer* lexer, const char* source_filename);
void baa_parser_free(BaaParser* parser);

// يحلل تدفق الرموز المميزة بالكامل، يُرجع BaaNode الجذر (نوع BAA_NODE_KIND_PROGRAM)
// أو NULL في حالة أخطاء غير قابلة للاستقبال.
BaaNode* baa_parse_program(BaaParser* parser);

bool baa_parser_had_error(const BaaParser* parser);

#endif // BAA_PARSER_H
```

## ٧. أمثلة الاستخدام

### استخدام أساسي للمحلل النحوي

```c
#include "baa/parser/parser.h"
#include "baa/lexer/lexer.h"

int main() {
    // كود مصدر عربي
    const wchar_t* source = L"عدد_صحيح جمع(عدد_صحيح أ، عدد_صحيح ب) {\n"
                           L"    إرجع أ + ب؛\n"
                           L"}\n"
                           L"\n"
                           L"عدد_صحيح الرئيسية() {\n"
                           L"    عدد_صحيح النتيجة = جمع(٥، ١٠)؛\n"
                           L"    إرجع النتيجة؛\n"
                           L"}";

    // إنشاء محلل لفظي
    BaaLexer lexer;
    baa_init_lexer(&lexer, source, L"example.ب");

    // إنشاء محلل نحوي
    BaaParser* parser = baa_parser_create(&lexer, "example.ب");

    // تحليل البرنامج
    BaaNode* program_ast = baa_parse_program(parser);

    if (program_ast) {
        printf("تم التحليل النحوي بنجاح!\n");
        // معالجة AST...
        baa_ast_free_node(program_ast);
    } else {
        printf("فشل التحليل النحوي.\n");
    }

    baa_parser_free(parser);
    return 0;
}
```

### معالجة الأخطاء المحسنة

```c
void parse_with_error_handling(const wchar_t* source, const char* filename) {
    BaaLexer lexer;
    baa_init_lexer(&lexer, source, filename);

    BaaParser* parser = baa_parser_create(&lexer, filename);

    BaaNode* ast = baa_parse_program(parser);

    if (baa_parser_had_error(parser)) {
        fprintf(stderr, "تم العثور على أخطاء نحوية في %s\n", filename);
        // يمكن إضافة معالجة أخطاء تفصيلية هنا
    }

    if (ast) {
        printf("تم إنشاء AST بنجاح\n");
        // معالجة AST...
        baa_ast_free_node(ast);
    }

    baa_parser_free(parser);
}
```

## ٨. التكامل مع المكونات الأخرى

### التكامل مع المحلل اللفظي

المحلل النحوي يعمل بشكل وثيق مع المحلل اللفظي لمعالجة الرموز المميزة:

- **استهلاك الرموز المميزة**: المحلل النحوي يستهلك الرموز المميزة من المحلل اللفظي واحداً تلو الآخر
- **معالجة المسافات البيضاء**: المحلل النحوي يتجاهل رموز المسافات البيضاء والتعليقات
- **معالجة الأخطاء**: يتعامل مع الأخطاء اللفظية والنحوية بشكل منسق

### التكامل مع AST

المحلل النحوي ينشئ عقد AST باستخدام دوال الإنشاء المحددة:

- **إنشاء العقد**: استخدام دوال مثل `baa_ast_new_function_def_node()`
- **إدارة الذاكرة**: ضمان التحرير المناسب للعقد في حالة الأخطاء
- **معلومات الموقع**: تضمين معلومات موقع دقيقة لكل عقدة

## ٩. التحسينات والخطط المستقبلية

### الميزات المخططة
- **دعم النطاقات المحلية**: متغيرات محلية داخل الدوال
- **معالجة أخطاء محسنة**: رسائل خطأ أكثر تفصيلاً بالعربية
- **تحسين الأداء**: تحسينات لسرعة التحليل النحوي
- **دعم ميزات إضافية**: حلقات، شروط، مصفوفات

### الصيانة والتطوير
- **اختبارات شاملة**: مجموعة اختبارات كاملة لجميع تركيبات اللغة
- **توثيق مفصل**: توثيق كامل لجميع دوال التحليل النحوي
- **أدوات التطوير**: أدوات مساعدة لتطوير وصيانة المحلل النحوي

---

*للحصول على معلومات مفصلة حول هيكل AST، راجع `docs/02_COMPILER_ARCHITECTURE/AST.md`.*
*للحصول على خطط التطوير المستقبلية، راجع `docs/04_ROADMAP/PARSER_ROADMAP.md`.*
