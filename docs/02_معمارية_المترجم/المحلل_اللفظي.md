# توثيق المحلل اللفظي للغة باء

**متاح باللغة:** [العربية](#) | [English](../02_COMPILER_ARCHITECTURE/LEXER.md)

## نظرة عامة

المحلل اللفظي للغة باء، والمعروف أيضاً بالمحلل المعجمي أو الماسح الضوئي، هو مكون أساسي في مترجم لغة باء. مسؤوليته تحويل كود مصدر باء الخام (الذي تمت **معالجته مسبقاً بواسطة المعالج المسبق للغة باء**) إلى تسلسل من وحدات ذات معنى تُسمى **الرموز المميزة**. هذه الرموز المميزة يتم تمريرها بعد ذلك إلى المحلل النحوي للغة باء للتحليل النحوي.

يعمل المحلل اللفظي على تدفق أحرف واسعة بترميز UTF-16LE، وهو تنسيق الإخراج من المعالج المسبق للغة باء. تم تصميمه بدعم قوي للعربية، بما في ذلك القدرة على توليد رموز مميزة للمعرفات العربية والكلمات المفتاحية وأشكال القيم الحرفية المختلفة.

## الميزات

### ١. التوليد الرمزي

الدور الأساسي للمحلل اللفظي هو تحديد وتصنيف تسلسلات الأحرف من تدفق الإدخال إلى رموز مميزة منفصلة. كل رمز مميز عادة ما يحتوي على:

* **نوع** (مثل، معرف، كلمة مفتاحية، قيمة حرفية عددية، عامل).
* **وحدة معجمية** (السلسلة الفعلية للأحرف من المصدر التي تشكل الرمز المميز).
* **معلومات موقع المصدر** (رقم السطر ورقم العمود البدائي).
  * على عكس العديد من المحللات اللفظية التقليدية التي تتجاهل المسافات البيضاء والتعليقات، فإن المحلل اللفظي للغة باء
  * يقوم بتوليد رموز مميزة لهذه العناصر. هذا يوفر تدفق رموز مميزة أكثر ثراءً يمكن أن يكون مفيداً
  * لأدوات مثل منسقات النصوص، والفاحصات، أو بيئات التطوير المتكاملة التي تتطلب الإخلاص الكامل للمصدر.
  * سيكون المحلل النحوي مسؤولاً عن تحديد كيفية التعامل مع هذه الرموز المميزة أو تجاهلها.

### ٢. دعم اللغة العربية

* **المعرفات:** يتعرف على المعرفات المكونة من الأحرف العربية (من نطاقات يونيكود القياسية للعربية)، والأحرف الإنجليزية، والأرقام العربية-الهندية (`٠`-`٩`)، والأرقام ASCII (`0-9`)، والشرطات السفلية (`_`).
* **الكلمات المفتاحية:** يحدد الكلمات المفتاحية العربية المحجوزة. مجموعة الكلمات المفتاحية الحالية تشمل:
  - `إذا` (if) - `BAA_TOKEN_IF`
  - `وإلا` (else) - `BAA_TOKEN_ELSE`
  - `طالما` (while) - `BAA_TOKEN_WHILE`
  - `لكل` (for) - `BAA_TOKEN_FOR`
  - `إرجع` (return) - `BAA_TOKEN_RETURN`
  - `ثابت` (const) - `BAA_TOKEN_CONST`
  - `مضمن` (inline) - `BAA_TOKEN_INLINE`
  - `مقيد` (restrict) - `BAA_TOKEN_RESTRICT`
  - `ساكن` (static) - `BAA_TOKEN_STATIC`
  - `خارجي` (extern) - `BAA_TOKEN_EXTERN`
  - `تلقائي` (auto) - `BAA_TOKEN_AUTO`
  - `سجل` (register) - `BAA_TOKEN_REGISTER`
  - `متطاير` (volatile) - `BAA_TOKEN_VOLATILE`
  - `فراغ` (void) - `BAA_TOKEN_VOID`
  - `حرف` (char) - `BAA_TOKEN_CHAR`
  - `قصير` (short) - `BAA_TOKEN_SHORT`
  - `عدد_صحيح` (int) - `BAA_TOKEN_INT`
  - `طويل` (long) - `BAA_TOKEN_LONG`
  - `عائم` (float) - `BAA_TOKEN_FLOAT`
  - `مضاعف` (double) - `BAA_TOKEN_DOUBLE`

  **ملاحظة:** تم إزالة الكلمات المفتاحية `دالة` (function) و `متغير` (variable) في الإصدار v0.1.17.0 حيث أن لغة باء تستخدم إعلانات الدوال والمتغيرات بأسلوب C. هذه الآن يتم توليد رموز مميزة لها كمعرفات.

### ٣. القيم الحرفية العددية

#### الأرقام العربية-الهندية
يدعم المحلل اللفظي الأرقام العربية-الهندية (`٠-٩`) جنباً إلى جنب مع أرقام ASCII (`0-9`):

```baa
عدد_صحيح رقم١ = ١٢٣;        // أرقام عربية-هندية
عدد_صحيح رقم٢ = 456;         // أرقام ASCII
عدد_صحيح رقم٣ = ١٢٣456;     // مختلط (مسموح)
```

#### الفاصلة العشرية العربية
استخدم الفاصلة العشرية العربية `٫` (U+066B) للأرقام العشرية:

```baa
عدد_حقيقي pi = ٣٫١٤١٥٩;
عدد_حقيقي نصف = ٠٫٥;
```

#### الترميز العلمي العربي
استخدم `أ` (حرف الألف العربي) كمؤشر الأس:

```baa
عدد_حقيقي كبير = ١٫٢٣أ٦;     // 1.23 × 10^6
عدد_حقيقي صغير = ٥أ-٣;       // 5 × 10^-3
```

#### اللواحق العربية للأرقام
| اللاحقة | الاسم العربي | المكافئ الإنجليزي | الوصف |
|--------|-------------|-------------------|-------|
| `غ` | غير موقع | unsigned | عدد صحيح غير موقع |
| `ط` | طويل | long | عدد صحيح طويل |
| `طط` | طويل طويل | long long | عدد صحيح طويل جداً |
| `ح` | حقيقي | float | نوع عائم |

### ٤. تسلسلات الهروب العربية

تستخدم لغة باء الأحرف العربية لتسلسلات الهروب بدلاً من الأحرف الإنجليزية:

| تسلسل باء | مكافئ C | الاسم العربي | يونيكود |
|-----------|---------|-------------|---------|
| `\س` | `\n` | سطر جديد | U+000A |
| `\م` | `\t` | علامة جدولة | U+0009 |
| `\ر` | `\r` | إرجاع العربة | U+000D |
| `\ص` | `\0` | محرف فارغ | U+0000 |
| `\يXXXX` | `\uXXXX` | يونيكود | محرف يونيكود |
| `\هـHH` | `\xHH` | سداسي عشري | قيمة بايت سداسية عشرية |

### ٥. معالجة التعليقات

يقوم المحلل اللفظي بتوليد رموز مميزة لجميع أنواع التعليقات، مع الحفاظ على محتواها للأدوات التي تتطلب الإخلاص الكامل للمصدر:

* **تعليقات السطر الواحد (`BAA_TOKEN_SINGLE_LINE_COMMENT`):**
  - الصيغة: `// نص التعليق`
  - الوحدة المعجمية تحتوي على النص بعد `//` حتى السطر الجديد (باستثناء `//`)

* **التعليقات متعددة الأسطر (`BAA_TOKEN_MULTI_LINE_COMMENT`):**
  - الصيغة: `/* نص التعليق */` (تعليقات غير توثيقية)
  - الوحدة المعجمية تحتوي على النص بين `/*` و `*/` (باستثناء المحددات)

* **التعليقات التوثيقية (`BAA_TOKEN_DOC_COMMENT`):**
  - الصيغة: `/** نص التوثيق */`
  - الوحدة المعجمية تحتوي على النص بين `/**` و `*/` (باستثناء المحددات)

### ٦. نظام معالجة الأخطاء المحسن

يحتوي المحلل اللفظي للغة باء على نظام شامل لمعالجة الأخطاء مصمم لتوفير ملاحظات واضحة وقابلة للتنفيذ للمطورين باللغة العربية.

#### أنواع الرموز المميزة للأخطاء المحددة

| نوع الخطأ | رمز الخطأ | الفئة | الوصف |
|-----------|----------|-------|-------|
| `BAA_TOKEN_ERROR_UNTERMINATED_STRING` | 1001 | string | علامة اقتباس إغلاق مفقودة في السلاسل النصية |
| `BAA_TOKEN_ERROR_INVALID_ESCAPE` | 1002 | escape | تسلسلات هروب غير صالحة في السلاسل/الأحرف |
| `BAA_TOKEN_ERROR_UNTERMINATED_CHAR` | 1003 | character | علامة اقتباس إغلاق مفقودة في القيم الحرفية |
| `BAA_TOKEN_ERROR_INVALID_CHARACTER` | 1004 | character | أحرف غير صالحة (مثل أسطر جديدة في القيم الحرفية) |
| `BAA_TOKEN_ERROR_INVALID_NUMBER` | 1005 | number | تنسيقات أرقام غير صالحة (مثل `0x` بدون أرقام) |
| `BAA_TOKEN_ERROR_INVALID_SUFFIX` | 1006 | number | لواحق حرفية غير صالحة (مثل `غغ`, `طططط`) |
| `BAA_TOKEN_ERROR_UNTERMINATED_COMMENT` | 1007 | comment | `*/` مفقود في نهاية التعليقات |

#### رسائل الخطأ والاقتراحات العربية

جميع رسائل الخطأ والاقتراحات يتم توفيرها باللغة العربية مع توصيات مناسبة للسياق:

##### أخطاء السلاسل النصية
**سلسلة نصية غير منتهية (1001)**
- الرسالة: `"سلسلة نصية غير منتهية (بدأت في السطر %zu، العمود %zu)"`
- الاقتراح: `"أضف علامة اقتباس مزدوجة \" في نهاية السلسلة"`

##### أخطاء تسلسلات الهروب
**تسلسل هروب غير صالح (1002)**
- اقتراحات مناسبة للسياق:
  - عام: `"استخدم تسلسل هروب صالح مثل \\س أو \\م أو \\يXXXX"`
  - محدد: `"استخدم \\س بدلاً من \\n للسطر الجديد"`
  - يونيكود: `"استخدم \\يXXXX للأحرف اليونيكود بدلاً من \\uXXXX"`

### ٧. البنية المعمارية المتقسمة

المحلل اللفظي منظم في عدة ملفات مصدر متخصصة للحفاظ على قابلية الصيانة والوضوح:

#### الملفات الأساسية
* **`lexer.c`**: منطق التوزيع الأساسي، جدول الكلمات المفتاحية العربية، والدوال المساعدة العامة
* **`token_scanners.c`**: دوال مسح متخصصة لفئات الرموز المختلفة
* **`lexer_char_utils.c`**: أدوات تصنيف الأحرف لدعم اللغة العربية
* **`number_parser.c`**: أداة تحليل الأرقام الشاملة

## واجهة برمجة التطبيقات

### تهيئة المحلل اللفظي

```c
#include "baa/lexer/lexer.h"

// الطريقة الأولى: محلل لفظي مخصص في المكدس (موصى به)
BaaLexer lexer;
baa_init_lexer(&lexer, preprocessed_source, source_filename);

// الطريقة الثانية: محلل لفظي مخصص في الكومة (قديم)
BaaLexer* lexer = baa_create_lexer(preprocessed_source);
```

### معالجة الرموز المميزة

```c
BaaToken* token;
do {
    token = baa_lexer_next_token(&lexer);
    if (!token) {
        // معالجة خطأ تخصيص الذاكرة
        break;
    }

    // معلومات الرمز المميز الأساسية
    wprintf(L"النوع: %ls، الوحدة المعجمية: '%.*ls'، السطر: %zu، العمود: %zu\n",
            baa_token_type_to_string(token->type),
            (int)token->length, token->lexeme,
            token->line, token->column);

    // معالجة الأخطاء المحسنة
    if (baa_token_is_error(token)) {
        fwprintf(stderr, L"خطأ لفظي [%u]: %ls\n",
                 token->error->error_code, token->lexeme);

        if (token->error->suggestion) {
            fwprintf(stderr, L"اقتراح: %ls\n", token->error->suggestion);
        }
    }

    BaaTokenType current_type = token->type;
    baa_free_token(token);
    if (current_type == BAA_TOKEN_EOF || current_type == BAA_TOKEN_ERROR) {
        break;
    }
} while (true);
```

## الميزات العربية

### المعرفات العربية
يمكن أن تحتوي المعرفات العربية في لغة باء على:
- **الأحرف العربية**: من نطاقات يونيكود U+0600-U+06FF, U+FB50-U+FDFF, U+FE70-U+FEFF
- **الأحرف الإنجليزية**: a-z, A-Z
- **الأرقام العربية-الهندية**: ٠١٢٣٤٥٦٧٨٩ (U+0660-U+0669)
- **أرقام ASCII**: 0-9
- **الشرطات السفلية**: _

**أمثلة:**
```baa
عدد_صحيح العدد = ٥;
عدد_حقيقي المتوسط = ٣٫١٤;
حرف الحرف_الأول = 'أ';
```

### دعم يونيكود الشامل
يوفر المحلل اللفظي دعماً شاملاً ليونيكود:

#### تصنيف الأحرف
- **اكتشاف الأحرف العربية**: يغطي جميع كتل يونيكود العربية
- **دعم الأرقام العربية-الهندية**: دعم كامل لـ ٠-٩
- **علامات الترقيم العربية**: يتعرف على علامات الترقيم العربية
- **دعم النصوص المختلطة**: يسمح بخلط النصوص العربية واللاتينية

## أمثلة التكامل

### الاستخدام الأساسي للمحلل اللفظي

```c
#include "baa/lexer/lexer.h"
#include <stdio.h>
#include <wchar.h>

int main() {
    // مثال على كود مصدر عربي
    const wchar_t* source = L"عدد_صحيح العدد = ١٢٣;\n"
                           L"إذا (العدد > ٠) {\n"
                           L"    إرجع صحيح;\n"
                           L"}";

    // تهيئة المحلل اللفظي
    BaaLexer lexer;
    baa_init_lexer(&lexer, source, L"example.ب");

    // معالجة الرموز المميزة
    BaaToken* token;
    while ((token = baa_lexer_next_token(&lexer)) != NULL) {
        // طباعة معلومات الرمز المميز
        wprintf(L"الرمز المميز: %ls، النوع: %ls، السطر: %zu، العمود: %zu\n",
                token->lexeme,
                baa_token_type_to_string(token->type),
                token->line,
                token->column);

        baa_free_token(token);
        if (token->type == BAA_TOKEN_EOF) break;
    }

    return 0;
}
```

## التحسينات المستقبلية

* دعم يونيكود إضافي للمعرفات بناءً على UAX #31
* تحسينات الأداء (مثل البحث عن الكلمات المفتاحية) حسب الحاجة
* تخطيط مصدر قوي إذا كان المعالج المسبق ينتج توجيهات `#line`
* التكامل مع أدوات بيئة التطوير المتكاملة لعرض الأخطاء المحسن

---

*للحصول على قائمة مفصلة بالمهام الجارية والخطط المستقبلية، راجع `docs/04_ROADMAP/LEXER_ROADMAP.md`.*
