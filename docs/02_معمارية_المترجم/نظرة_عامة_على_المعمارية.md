# نظرة عامة على معمارية مترجم لغة باء

## الفلسفة التصميمية

مترجم لغة باء مصمم وفقاً لمبادئ المترجمات الحديثة مع التركيز على:

- **الوضوح والبساطة**: كود واضح وقابل للقراءة
- **القابلية للصيانة**: معمارية معيارية مع واجهات محددة بوضوح
- **دعم اللغة العربية**: تكامل أصيل للغة العربية في جميع المستويات
- **التوافق مع C**: الحفاظ على المفاهيم المألوفة مع إضافة النحو العربي
- **الأداء**: تحسينات مناسبة بدون تعقيد مفرط

## نظرة عامة على المراحل

مترجم باء يتبع مراحل التجميع الكلاسيكية مع تحسينات للدعم العربي:

```
ملف المصدر باء (.ب)
        ↓
    [معالج مسبق]     ← توجيهات عربية (#تضمين، #تعريف، #إذا)
        ↓
     تدفق UTF-16
        ↓
    [محلل لفظي]      ← كلمات مفتاحية عربية، أرقام عربية-هندية
        ↓
     تدفق الرموز
        ↓
    [محلل نحوي]      ← نحو عربي، تحليل نزولي تكراري
        ↓
   شجرة نحو مجردة
        ↓
   [محلل دلالي]      ← فحص الأنواع، حل الرموز (مخطط)
        ↓
 شجرة نحو محققة
        ↓
   [مولد الكود]      ← LLVM IR (مخطط)
        ↓
    كود الهدف
```

## المكونات الرئيسية

### 1. المعالج المسبق (Preprocessor) ✅

**الحالة**: مكتمل 100% - جاهز للإنتاج

**المسؤوليات**:
- معالجة توجيهات المعالج المسبق العربية
- إدارة الماكروات والتجميع الشرطي
- تضمين الملفات مع اكتشاف التضمين الدائري
- كشف ترميز الملفات وتحويل إلى UTF-16LE

**التوجيهات المدعومة**:
```baa
#تضمين "ملف.ب"          // تضمين ملف
#تعريف PI 3.14159        // تعريف ماكرو
#إذا معرف(DEBUG)         // تجميع شرطي
#وإلا_إذا VERSION > 1    // شرط إضافي
#إلا                     // الفرع الافتراضي
#نهاية_إذا               // نهاية الكتلة الشرطية
```

### 2. المحلل اللفظي (Lexer) ✅

**الحالة**: مكتمل 100% - جاهز للإنتاج

**المسؤوليات**:
- تحليل تدفق UTF-16LE إلى رموز
- دعم الكلمات المفتاحية العربية
- تحليل الأرقام العربية-الهندية
- معالجة تسلسلات الهروب العربية المخصصة

**الميزات الرئيسية**:
```baa
// الكلمات المفتاحية العربية
عدد_صحيح، عدد_حقيقي، حرف، منطقي
إذا، وإلا، طالما، لكل، إرجع

// الأرقام العربية-الهندية
عدد_صحيح = ١٢٣٤٥.
عدد_حقيقي = ٣٫١٤١٥٩.
عدد_علمي = ١٫٢٣أ٦.

// تسلسلات الهروب العربية
حرف سطر_جديد = '\س'.      // \n
حرف تاب = '\م'.            // \t
حرف همزة = '\ي0623'.       // Unicode
```

### 3. المحلل النحوي (Parser) ✅

**الحالة**: مكتمل 100% للميزات الأساسية - جاهز للإنتاج

**المعمارية**: محلل نحوي تنازلي تكراري (Recursive Descent)

**المسؤوليات**:
- تحليل تدفق الرموز إلى شجرة نحو مجردة
- معالجة شاملة للأخطاء مع الاسترداد
- دعم جميع البنى النحوية لباء
- تطبيق أولوية العمليات بصورة صحيحة

**البنى المدعومة**:
```baa
// إعلانات المتغيرات
عدد_صحيح العدد = ١٠.
ثابت عدد_حقيقي PI = ٣٫١٤.

// تعريفات الدوال
عدد_صحيح جمع(عدد_صحيح أ، عدد_صحيح ب) {
    إرجع أ + ب.
}

// جمل التحكم
إذا (العدد > ٠) {
    اطبع("موجب").
} وإلا {
    اطبع("سالب أو صفر").
}

// الحلقات
لكل (عدد_صحيح ي = ٠؛ ي < ١٠؛ ي++) {
    اطبع(ي).
}
```

### 4. شجرة النحو المجردة (AST) ✅

**الحالة**: مكتمل 100% - جاهز للإنتاج

**التصميم**: هيكل `BaaNode` موحد مع اتحاد مميز

**المسؤوليات**:
- تمثيل موحد لجميع البنى اللغوية
- إدارة ذاكرة آمنة مع تنظيف تلقائي
- تتبع مواقع المصدر للتشخيصات الدقيقة
- دعم التنقل والتحويل

**أنواع العقد**:
```c
typedef enum {
    // التعبيرات
    BAA_NODE_KIND_LITERAL,           // القيم الحرفية
    BAA_NODE_KIND_IDENTIFIER,        // المعرفات
    BAA_NODE_KIND_BINARY_EXPR,       // العمليات الثنائية
    BAA_NODE_KIND_UNARY_EXPR,        // العمليات الأحادية
    BAA_NODE_KIND_CALL_EXPR,         // استدعاءات الدوال
    
    // الجمل
    BAA_NODE_KIND_EXPRESSION_STMT,   // جمل التعبير
    BAA_NODE_KIND_IF_STMT,           // جمل الشرط
    BAA_NODE_KIND_WHILE_STMT,        // جمل التكرار
    BAA_NODE_KIND_RETURN_STMT,       // جمل الإرجاع
    BAA_NODE_KIND_BLOCK_STMT,        // الكتل
    
    // الإعلانات
    BAA_NODE_KIND_VAR_DECL,          // إعلانات المتغيرات
    BAA_NODE_KIND_FUNCTION_DEF,      // تعريفات الدوال
    BAA_NODE_KIND_PARAMETER,         // معاملات الدوال
    
    // البرنامج
    BAA_NODE_KIND_PROGRAM            // جذر البرنامج
} BaaNodeKind;
```

### 5. نظام الأنواع (Type System) 🔄

**الحالة**: الأساسيات منفذة، التوسع مخطط

**المسؤوليات**:
- تعريف الأنواع الأساسية والمركبة
- قواعد التحويل والتوافق
- فحص صحة العمليات

**الأنواع الحالية**:
```c
typedef enum {
    BAA_TYPE_VOID,           // فراغ
    BAA_TYPE_INT,            // عدد_صحيح
    BAA_TYPE_FLOAT,          // عدد_حقيقي
    BAA_TYPE_CHAR,           // حرف
    BAA_TYPE_BOOL,           // منطقي
    BAA_TYPE_ARRAY,          // مصفوفة (مخطط)
    BAA_TYPE_STRUCT,         // بنية (مخطط)
    BAA_TYPE_POINTER         // مؤشر (مخطط)
} BaaTypeKind;
```

### 6. التحليل الدلالي (Semantic Analysis) 📋

**الحالة**: مخطط للأولوية 5

**المسؤوليات المخططة**:
- إدارة جداول الرموز ونطاقات الرؤية
- فحص الأنواع والتحقق من التوافق
- حل المعرفات وربطها بتعريفاتها
- تحليل تدفق التحكم واكتشاف الأخطاء

### 7. توليد الكود (Code Generation) 📋

**الحالة**: بنية أساسية، تكامل LLVM مخطط

**المسؤوليات المخططة**:
- توليد LLVM IR من شجرة النحو المجردة
- تطبيق تحسينات الكود
- دعم منصات متعددة
- تكامل مع أدوات التصحيح

## تدفق البيانات والتفاعل

### مرحلة المعالجة المسبقة

```
ملف_المصدر.ب
       ↓ [UTF-8/UTF-16 Detection]
   مجرى_خام
       ↓ [Directive Processing]
   تدفق_مُعالج (UTF-16LE)
```

### مرحلة التحليل اللفظي

```
تدفق_UTF-16LE
       ↓ [Character Classification]
   رموز_أولية
       ↓ [Keyword Recognition]
   رموز_مصنفة
       ↓ [Arabic Number Processing]
   تدفق_رموز_نهائي
```

### مرحلة التحليل النحوي

```
تدفق_الرموز
       ↓ [Recursive Descent Parsing]
   عقد_جزئية
       ↓ [AST Node Construction]
   شجرة_نحو_مجردة
       ↓ [Source Location Tracking]
   شجرة_نحو_موثقة
```

## إدارة الأخطاء والتشخيصات

### نظام التشخيصات

```c
typedef struct {
    BaaDiagnosticLevel level;    // خطأ، تحذير، ملاحظة
    BaaSourceLocation location; // موقع المشكلة
    const char* message_ar;     // الرسالة بالعربية
    const char* message_en;     // الرسالة بالإنجليزية
    BaaSourceRange context;     // السياق المحيط
} BaaDiagnostic;
```

### استراتيجيات الاسترداد

1. **المعالج المسبق**: تجاهل التوجيهات الخاطئة والمتابعة
2. **المحلل اللفظي**: تسجيل رموز خطأ والمتابعة
3. **المحلل النحوي**: مزامنة على نقاط استرداد معرفة
4. **التحليل الدلالي**: المتابعة بعد تسجيل الأخطاء

## التحسينات والأداء

### استراتيجيات الذاكرة

1. **تجميع الذاكرة**: استخدام مُخصصات مخصصة للعقد
2. **إعادة الاستخدام**: تجميع الكائنات المؤقتة
3. **التنظيف التلقائي**: تنظيف هرمي لشجرة النحو المجردة

### تحسينات الأداء

1. **تخزين مؤقت للرموز**: تخزين مؤقت لحالات البحث الشائعة
2. **تحليل تزايدي**: إعادة تحليل الأجزاء المتغيرة فقط
3. **المعالجة المتوازية**: معالجة ملفات متعددة بالتوازي

## الامتداد والتطوير

### إضافة ميزات لغوية جديدة

1. **تحديث المحلل اللفظي**: إضافة كلمات مفتاحية جديدة
2. **تمديد المحلل النحوي**: إضافة قواعد نحوية
3. **توسيع شجرة النحو المجردة**: تعريف أنواع عقد جديدة
4. **تحديث التحليل الدلالي**: إضافة قواعد تحقق

### إرشادات التطوير

1. **الاختبارات أولاً**: كتابة اختبارات قبل التنفيذ
2. **التوثيق المتزامن**: تحديث التوثيق مع الكود
3. **الواجهات الثابتة**: تجنب كسر الواجهات الموجودة
4. **المراجعة الثنائية**: مراجعة جميع التغييرات

## المبادئ المعمارية

### 1. الفصل بين الاهتمامات
- كل مكون له مسؤولية واضحة ومحددة
- التفاعل من خلال واجهات محددة بوضوح
- تجنب التبعيات الدائرية

### 2. قابلية الاختبار
- كل مكون قابل للاختبار بشكل منفصل
- حقن التبعيات حيث أمكن
- اختبارات شاملة لجميع الواجهات

### 3. قابلية الصيانة
- كود واضح ومؤثق
- أسماء ذات معنى للدوال والمتغيرات
- تجميع منطقي للوظائف ذات الصلة

### 4. الأداء
- تحسينات مبررة بقياسات فعلية
- تجنب التحسين المبكر
- الحفاظ على البساطة أولاً

---

**معمارية مترجم باء مصممة لتكون قوية وقابلة للصيانة مع دعم أصيل للغة العربية في جميع المستويات.**
