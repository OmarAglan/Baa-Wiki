# مرجع واجهة برمجة المعالج المسبق للغة باء

**متاح باللغة:** [العربية](#) | [English](../05_API_REFERENCE/PREPROCESSOR_API.md)

يوفر هذا المستند مرجعاً شاملاً لواجهة برمجة تطبيقات المعالج المسبق في مترجم لغة باء. المعالج المسبق مسؤول عن معالجة توجيهات المعالج المسبق، تضمين الملفات، توسيع الوحدات الماكرو، والتعامل مع التوجيهات الشرطية.

## نظرة عامة

المعالج المسبق للغة باء يدعم مجموعة شاملة من الميزات المتوافقة مع C، مع دعم خاص للنصوص العربية وترميز UTF-8/UTF-16. يعمل كمرحلة أولى في عملية التجميع، حيث يحول الكود المصدر قبل تمريره إلى المحلل اللفظي.

## الهياكل الأساسية

### BaaPreprocessor

```c
typedef struct BaaPreprocessor BaaPreprocessor;
```

هيكل المعالج المسبق الرئيسي يحتوي على جميع المعلومات اللازمة لمعالجة الملفات المصدر.

### BaaPreprocessorOptions

```c
typedef struct {
    bool enable_line_directives;     // تمكين توجيهات #line
    bool preserve_comments;          // الحفاظ على التعليقات في الإخراج
    bool enable_macro_expansion;     // تمكين توسيع الوحدات الماكرو
    size_t max_include_depth;        // العمق الأقصى للتضمين (افتراضي: 256)
    const wchar_t** include_paths;   // مسارات البحث عن الملفات المضمنة
    size_t include_path_count;       // عدد مسارات التضمين
} BaaPreprocessorOptions;
```

### BaaPreprocessorResult

```c
typedef struct {
    wchar_t* processed_source;       // الكود المُعالج
    size_t source_length;            // طول الكود المُعالج
    bool has_errors;                 // هل حدثت أخطاء؟
    wchar_t** error_messages;        // رسائل الخطأ
    size_t error_count;              // عدد الأخطاء
    wchar_t** warning_messages;      // رسائل التحذير
    size_t warning_count;            // عدد التحذيرات
} BaaPreprocessorResult;
```

## الدوال الأساسية

### إنشاء وتحرير المعالج المسبق

#### `BaaPreprocessor* baa_preprocessor_create(const BaaPreprocessorOptions* options)`

ينشئ نسخة جديدة من المعالج المسبق.

**المعاملات:**
- `options`: خيارات تكوين المعالج المسبق (يمكن أن تكون NULL للإعدادات الافتراضية)

**القيمة المُرجعة:**
- مؤشر إلى `BaaPreprocessor` جديد، أو NULL في حالة فشل التخصيص

**مثال:**
```c
BaaPreprocessorOptions options = {
    .enable_line_directives = true,
    .preserve_comments = false,
    .enable_macro_expansion = true,
    .max_include_depth = 128
};

BaaPreprocessor* preprocessor = baa_preprocessor_create(&options);
if (!preprocessor) {
    fprintf(stderr, "فشل في إنشاء المعالج المسبق\n");
    return -1;
}
```

#### `void baa_preprocessor_free(BaaPreprocessor* preprocessor)`

يحرر ذاكرة المعالج المسبق وجميع الموارد المرتبطة به.

**المعاملات:**
- `preprocessor`: مؤشر إلى المعالج المسبق المراد تحريره

**مثال:**
```c
baa_preprocessor_free(preprocessor);
```

### معالجة الملفات

#### `BaaPreprocessorResult* baa_preprocessor_process_file(BaaPreprocessor* preprocessor, const wchar_t* filename)`

يعالج ملف مصدر كامل.

**المعاملات:**
- `preprocessor`: مؤشر إلى المعالج المسبق
- `filename`: مسار الملف المراد معالجته

**القيمة المُرجعة:**
- مؤشر إلى `BaaPreprocessorResult` يحتوي على النتائج

**مثال:**
```c
BaaPreprocessorResult* result = baa_preprocessor_process_file(preprocessor, L"program.ب");
if (result->has_errors) {
    for (size_t i = 0; i < result->error_count; i++) {
        fwprintf(stderr, L"خطأ: %ls\n", result->error_messages[i]);
    }
} else {
    wprintf(L"تمت المعالجة بنجاح\n");
    // استخدام result->processed_source
}
baa_preprocessor_result_free(result);
```

#### `BaaPreprocessorResult* baa_preprocessor_process_string(BaaPreprocessor* preprocessor, const wchar_t* source, const wchar_t* source_name)`

يعالج سلسلة نصية تحتوي على كود مصدر.

**المعاملات:**
- `preprocessor`: مؤشر إلى المعالج المسبق
- `source`: الكود المصدر كسلسلة نصية
- `source_name`: اسم المصدر للإبلاغ عن الأخطاء

**القيمة المُرجعة:**
- مؤشر إلى `BaaPreprocessorResult` يحتوي على النتائج

**مثال:**
```c
const wchar_t* source = L"#تضمين \"stdio.h\"\n"
                       L"#تعريف MAX_SIZE ١٠٠\n"
                       L"عدد_صحيح الرئيسية() {\n"
                       L"    إرجع ٠؛\n"
                       L"}";

BaaPreprocessorResult* result = baa_preprocessor_process_string(preprocessor, source, L"test.ب");
```

### إدارة الوحدات الماكرو

#### `bool baa_preprocessor_define_macro(BaaPreprocessor* preprocessor, const wchar_t* name, const wchar_t* value)`

يعرّف وحدة ماكرو جديدة.

**المعاملات:**
- `preprocessor`: مؤشر إلى المعالج المسبق
- `name`: اسم الوحدة الماكرو
- `value`: قيمة الوحدة الماكرو (يمكن أن تكون NULL للوحدات الماكرو بدون قيمة)

**القيمة المُرجعة:**
- `true` في حالة النجاح، `false` في حالة الفشل

**مثال:**
```c
// تعريف وحدة ماكرو بسيطة
baa_preprocessor_define_macro(preprocessor, L"النسخة", L"\"١.٠.٠\"");

// تعريف وحدة ماكرو بدون قيمة
baa_preprocessor_define_macro(preprocessor, L"تصحيح_الأخطاء", NULL);
```

#### `bool baa_preprocessor_undefine_macro(BaaPreprocessor* preprocessor, const wchar_t* name)`

يلغي تعريف وحدة ماكرو.

**المعاملات:**
- `preprocessor`: مؤشر إلى المعالج المسبق
- `name`: اسم الوحدة الماكرو المراد إلغاؤها

**القيمة المُرجعة:**
- `true` في حالة النجاح، `false` إذا لم تكن الوحدة الماكرو موجودة

**مثال:**
```c
baa_preprocessor_undefine_macro(preprocessor, L"تصحيح_الأخطاء");
```

#### `bool baa_preprocessor_is_macro_defined(const BaaPreprocessor* preprocessor, const wchar_t* name)`

يتحقق من وجود وحدة ماكرو.

**المعاملات:**
- `preprocessor`: مؤشر إلى المعالج المسبق
- `name`: اسم الوحدة الماكرو

**القيمة المُرجعة:**
- `true` إذا كانت الوحدة الماكرو معرّفة، `false` خلاف ذلك

**مثال:**
```c
if (baa_preprocessor_is_macro_defined(preprocessor, L"النسخة")) {
    wprintf(L"وحدة الماكرو 'النسخة' معرّفة\n");
}
```

### إدارة مسارات التضمين

#### `bool baa_preprocessor_add_include_path(BaaPreprocessor* preprocessor, const wchar_t* path)`

يضيف مسار بحث للملفات المضمنة.

**المعاملات:**
- `preprocessor`: مؤشر إلى المعالج المسبق
- `path`: مسار المجلد المراد إضافته

**القيمة المُرجعة:**
- `true` في حالة النجاح، `false` في حالة الفشل

**مثال:**
```c
baa_preprocessor_add_include_path(preprocessor, L"/usr/include");
baa_preprocessor_add_include_path(preprocessor, L"./headers");
```

#### `void baa_preprocessor_clear_include_paths(BaaPreprocessor* preprocessor)`

يمسح جميع مسارات التضمين.

**المعاملات:**
- `preprocessor`: مؤشر إلى المعالج المسبق

**مثال:**
```c
baa_preprocessor_clear_include_paths(preprocessor);
```

### معالجة النتائج

#### `void baa_preprocessor_result_free(BaaPreprocessorResult* result)`

يحرر ذاكرة نتيجة المعالجة.

**المعاملات:**
- `result`: مؤشر إلى النتيجة المراد تحريرها

**مثال:**
```c
BaaPreprocessorResult* result = baa_preprocessor_process_file(preprocessor, L"program.ب");
// استخدام النتيجة...
baa_preprocessor_result_free(result);
```

## التوجيهات المدعومة

المعالج المسبق يدعم التوجيهات التالية:

### توجيهات التضمين

#### `#تضمين "ملف.ب"`
يضمن محتويات الملف المحدد.

**مثال:**
```c
#تضمين "مكتبة.ب"
#تضمين <stdio.h>
```

#### `#تضمين_مرة "ملف.ب"`
يضمن الملف مرة واحدة فقط (مكافئ لـ `#pragma once`).

### توجيهات الوحدات الماكرو

#### `#تعريف اسم قيمة`
يعرّف وحدة ماكرو.

**مثال:**
```c
#تعريف الحد_الأقصى ١٠٠
#تعريف رسالة "مرحبا بالعالم"
```

#### `#إلغاء_تعريف اسم`
يلغي تعريف وحدة ماكرو.

**مثال:**
```c
#إلغاء_تعريف الحد_الأقصى
```

### التوجيهات الشرطية

#### `#إذا تعبير`
بداية كتلة شرطية.

#### `#إذا_عُرف اسم`
يتحقق من وجود وحدة ماكرو.

#### `#إذا_لم_يُعرف اسم`
يتحقق من عدم وجود وحدة ماكرو.

#### `#وإلا_إذا تعبير`
شرط بديل.

#### `#وإلا`
الفرع البديل.

#### `#نهاية_إذا`
نهاية الكتلة الشرطية.

**مثال:**
```c
#إذا_عُرف تصحيح_الأخطاء
    // كود تصحيح الأخطاء
#وإلا_إذا عُرف الوضع_الصامت
    // كود الوضع الصامت
#وإلا
    // كود عادي
#نهاية_إذا
```

### توجيهات أخرى

#### `#خطأ "رسالة"`
يصدر خطأ في وقت المعالجة.

#### `#تحذير "رسالة"`
يصدر تحذير في وقت المعالجة.

#### `#سطر رقم "ملف"`
يغير معلومات السطر والملف الحالية.

## معالجة الأخطاء

### أنواع الأخطاء

المعالج المسبق يمكنه إصدار الأخطاء التالية:

1. **ملف غير موجود**: عند محاولة تضمين ملف غير موجود
2. **تضمين دائري**: عند حدوث تضمين دائري للملفات
3. **عمق تضمين مفرط**: عند تجاوز العمق الأقصى للتضمين
4. **وحدة ماكرو غير معرّفة**: عند استخدام وحدة ماكرو غير معرّفة
5. **خطأ في الصيغة**: عند وجود خطأ في صيغة التوجيهات

### مثال معالجة شاملة للأخطاء

```c
#include "baa/preprocessor/preprocessor.h"
#include <stdio.h>
#include <wchar.h>

int process_file_with_error_handling(const wchar_t* filename) {
    // إنشاء المعالج المسبق
    BaaPreprocessorOptions options = {
        .enable_line_directives = true,
        .preserve_comments = false,
        .enable_macro_expansion = true,
        .max_include_depth = 64
    };
    
    BaaPreprocessor* preprocessor = baa_preprocessor_create(&options);
    if (!preprocessor) {
        fwprintf(stderr, L"فشل في إنشاء المعالج المسبق\n");
        return -1;
    }
    
    // إضافة مسارات التضمين
    baa_preprocessor_add_include_path(preprocessor, L"./include");
    baa_preprocessor_add_include_path(preprocessor, L"/usr/local/include");
    
    // تعريف وحدات ماكرو مسبقة
    baa_preprocessor_define_macro(preprocessor, L"__BAA__", L"1");
    baa_preprocessor_define_macro(preprocessor, L"النسخة", L"\"1.0.0\"");
    
    // معالجة الملف
    BaaPreprocessorResult* result = baa_preprocessor_process_file(preprocessor, filename);
    
    if (result->has_errors) {
        fwprintf(stderr, L"أخطاء في المعالجة المسبقة:\n");
        for (size_t i = 0; i < result->error_count; i++) {
            fwprintf(stderr, L"  خطأ: %ls\n", result->error_messages[i]);
        }
        
        baa_preprocessor_result_free(result);
        baa_preprocessor_free(preprocessor);
        return -1;
    }
    
    // طباعة التحذيرات إن وجدت
    if (result->warning_count > 0) {
        fwprintf(stderr, L"تحذيرات:\n");
        for (size_t i = 0; i < result->warning_count; i++) {
            fwprintf(stderr, L"  تحذير: %ls\n", result->warning_messages[i]);
        }
    }
    
    // النجاح - يمكن استخدام result->processed_source
    wprintf(L"تمت المعالجة بنجاح. حجم الإخراج: %zu أحرف\n", result->source_length);
    
    // تحرير الموارد
    baa_preprocessor_result_free(result);
    baa_preprocessor_free(preprocessor);
    
    return 0;
}
```

## أفضل الممارسات

### إدارة الذاكرة
1. **تحرر دائماً النتائج**: استخدم `baa_preprocessor_result_free()` لتحرير النتائج
2. **تحرر المعالج المسبق**: استخدم `baa_preprocessor_free()` عند الانتهاء
3. **تحقق من NULL**: تحقق دائماً من قيم الإرجاع NULL

### الأداء
1. **إعادة استخدام المعالج المسبق**: أنشئ معالج مسبق واحد واستخدمه لملفات متعددة
2. **حدد العمق الأقصى**: ضع حد معقول لعمق التضمين
3. **مسارات التضمين**: رتب مسارات التضمين بحسب الأولوية

### الأمان
1. **تحقق من مسارات الملفات**: تأكد من أن مسارات الملفات آمنة
2. **حدد حجم الملفات**: ضع حد أقصى لحجم الملفات المعالجة
3. **معالجة الأخطاء**: تعامل مع جميع حالات الأخطاء المحتملة

---

*للحصول على معلومات حول التكامل مع المحلل اللفظي، راجع `docs/02_COMPILER_ARCHITECTURE/LEXER.md`.*
*للحصول على أمثلة تفصيلية، راجع `docs/_assets/examples/`.*
