# واجهة برمجة شجرة النحو المجردة

## نظرة عامة

شجرة النحو المجردة (Abstract Syntax Tree - AST) هي التمثيل الداخلي لبرنامج باء بعد التحليل النحوي. تستخدم لغة باء نظام عقد موحد مع اتحاد مميز لتمثيل جميع البنى اللغوية بشكل فعال وآمن.

## الملفات الرئيسية

- `include/baa/ast/ast.h` - الواجهة العامة الرئيسية
- `include/baa/ast/ast_types.h` - تعريفات الأنواع والعقد
- `src/ast/ast_node.c` - تنفيذ العقدة الأساسية
- `src/ast/ast_expressions.c` - عقد التعبيرات
- `src/ast/ast_statements.c` - عقد الجمل
- `src/ast/ast_declarations.c` - عقد الإعلانات
- `src/ast/ast_program.c` - عقدة البرنامج الرئيسية

## الهياكل والأنواع الأساسية

### `BaaNode`

```c
typedef struct BaaNode {
    BaaNodeKind kind;               // نوع العقدة
    BaaSourceLocation location;     // موقع العقدة في المصدر
    BaaSourceRange source_range;    // النطاق الكامل في المصدر
    struct BaaNode* parent;         // العقدة الأب
    BaaNodeList* children;          // قائمة العقد الأطفال
    
    union {
        BaaLiteralData literal;         // للقيم الحرفية
        BaaIdentifierData identifier;   // للمعرفات
        BaaBinaryExprData binary_expr;  // للتعبيرات الثنائية
        BaaUnaryExprData unary_expr;    // للتعبيرات الأحادية
        BaaCallExprData call_expr;      // لاستدعاءات الدوال
        BaaIfStmtData if_stmt;          // لجمل الشرط
        BaaWhileStmtData while_stmt;    // لجمل التكرار
        BaaForStmtData for_stmt;        // لجمل الحلقة
        BaaReturnStmtData return_stmt;  // لجمل الإرجاع
        BaaVarDeclData var_decl;        // لإعلانات المتغيرات
        BaaFunctionDefData func_def;    // لتعريفات الدوال
        BaaParameterData parameter;     // لمعاملات الدوال
        BaaProgramData program;         // للبرنامج الرئيسي
    } data;
} BaaNode;
```

### `BaaNodeKind`

```c
typedef enum {
    // القيم الحرفية والمعرفات
    BAA_NODE_KIND_LITERAL,          // قيمة حرفية (رقم، نص، حرف، منطقي)
    BAA_NODE_KIND_IDENTIFIER,       // معرف (اسم متغير، دالة، إلخ)
    
    // التعبيرات
    BAA_NODE_KIND_BINARY_EXPR,      // تعبير ثنائي (أ + ب)
    BAA_NODE_KIND_UNARY_EXPR,       // تعبير أحادي (-أ، !ب)
    BAA_NODE_KIND_CALL_EXPR,        // استدعاء دالة (دالة(معاملات))
    BAA_NODE_KIND_ASSIGN_EXPR,      // تعبير تعيين (أ = ب)
    BAA_NODE_KIND_CONDITIONAL_EXPR, // تعبير شرطي (أ ? ب : ج)
    BAA_NODE_KIND_CAST_EXPR,        // تحويل نوع ((نوع)قيمة)
    BAA_NODE_KIND_MEMBER_EXPR,      // وصول عضو (كائن.عضو)
    BAA_NODE_KIND_INDEX_EXPR,       // فهرسة مصفوفة (مصفوفة[فهرس])
    
    // الجمل
    BAA_NODE_KIND_EXPRESSION_STMT,  // جملة تعبير (تعبير.)
    BAA_NODE_KIND_BLOCK_STMT,       // كتلة جمل ({...})
    BAA_NODE_KIND_IF_STMT,          // جملة شرطية (إذا...وإلا)
    BAA_NODE_KIND_WHILE_STMT,       // جملة تكرار (طالما)
    BAA_NODE_KIND_FOR_STMT,         // جملة حلقة (لكل)
    BAA_NODE_KIND_DO_WHILE_STMT,    // جملة افعل-طالما
    BAA_NODE_KIND_RETURN_STMT,      // جملة إرجاع (إرجع)
    BAA_NODE_KIND_BREAK_STMT,       // جملة توقف (توقف)
    BAA_NODE_KIND_CONTINUE_STMT,    // جملة استمرار (استمر)
    
    // الإعلانات
    BAA_NODE_KIND_VAR_DECL,         // إعلان متغير
    BAA_NODE_KIND_FUNCTION_DEF,     // تعريف دالة
    BAA_NODE_KIND_PARAMETER,        // معامل دالة
    BAA_NODE_KIND_TYPE_SPECIFIER,   // محدد نوع
    
    // هياكل البرنامج
    BAA_NODE_KIND_PROGRAM,          // البرنامج الرئيسي
    BAA_NODE_KIND_TRANSLATION_UNIT  // وحدة ترجمة
} BaaNodeKind;
```

### بيانات العقد المتخصصة

#### `BaaLiteralData`

```c
typedef struct {
    BaaLiteralKind literal_kind;    // نوع القيمة الحرفية
    union {
        long long int_value;        // للأعداد الصحيحة
        double float_value;         // للأعداد العشرية
        wchar_t char_value;         // للحروف
        wchar_t* string_value;      // للسلاسل النصية
        bool bool_value;            // للقيم المنطقية
    } value;
} BaaLiteralData;
```

#### `BaaIdentifierData`

```c
typedef struct {
    wchar_t* name;                  // اسم المعرف
    size_t name_length;             // طول الاسم
} BaaIdentifierData;
```

#### `BaaBinaryExprData`

```c
typedef struct {
    BaaOperatorKind operator;       // نوع العملية
    BaaNode* left;                  // المعامل الأيسر
    BaaNode* right;                 // المعامل الأيمن
    BaaSourceLocation op_location;  // موقع العملية
} BaaBinaryExprData;
```

#### `BaaCallExprData`

```c
typedef struct {
    BaaNode* function;              // تعبير الدالة (عادة معرف)
    BaaNodeList* arguments;         // قائمة المعاملات
    size_t argument_count;          // عدد المعاملات
} BaaCallExprData;
```

## الدوال العامة لإدارة العقد

### إنشاء العقد

#### `baa_node_create`

```c
BaaNode* baa_node_create(BaaNodeKind kind, BaaSourceLocation location);
```

**الوصف**: ينشئ عقدة جديدة بنوع وموقع محددين.

**المعاملات**:
- `kind`: نوع العقدة
- `location`: موقع العقدة في المصدر

**القيمة المرجعة**: مؤشر إلى العقدة الجديدة

#### دوال إنشاء متخصصة

```c
// إنشاء قيمة حرفية
BaaNode* baa_node_create_literal_int(long long value, BaaSourceLocation location);
BaaNode* baa_node_create_literal_float(double value, BaaSourceLocation location);
BaaNode* baa_node_create_literal_char(wchar_t value, BaaSourceLocation location);
BaaNode* baa_node_create_literal_string(const wchar_t* value, BaaSourceLocation location);
BaaNode* baa_node_create_literal_bool(bool value, BaaSourceLocation location);

// إنشاء معرف
BaaNode* baa_node_create_identifier(const wchar_t* name, BaaSourceLocation location);

// إنشاء تعبيرات
BaaNode* baa_node_create_binary_expr(BaaOperatorKind op, BaaNode* left, BaaNode* right, 
                                    BaaSourceLocation op_location);
BaaNode* baa_node_create_unary_expr(BaaOperatorKind op, BaaNode* operand, 
                                   BaaSourceLocation op_location);
BaaNode* baa_node_create_call_expr(BaaNode* function, BaaNodeList* arguments, 
                                  BaaSourceLocation location);

// إنشاء جمل
BaaNode* baa_node_create_if_stmt(BaaNode* condition, BaaNode* then_stmt, BaaNode* else_stmt, 
                                BaaSourceLocation location);
BaaNode* baa_node_create_while_stmt(BaaNode* condition, BaaNode* body, 
                                   BaaSourceLocation location);
BaaNode* baa_node_create_return_stmt(BaaNode* value, BaaSourceLocation location);
BaaNode* baa_node_create_block_stmt(BaaNodeList* statements, BaaSourceLocation location);

// إنشاء إعلانات
BaaNode* baa_node_create_var_decl(BaaTypeSpecifier* type, const wchar_t* name, 
                                 BaaNode* initializer, BaaSourceLocation location);
BaaNode* baa_node_create_function_def(BaaTypeSpecifier* return_type, const wchar_t* name,
                                     BaaNodeList* parameters, BaaNode* body, 
                                     BaaSourceLocation location);
```

### إدارة الشجرة

#### `baa_node_add_child`

```c
void baa_node_add_child(BaaNode* parent, BaaNode* child);
```

**الوصف**: يضيف عقدة طفل إلى عقدة أب.

#### `baa_node_remove_child`

```c
bool baa_node_remove_child(BaaNode* parent, BaaNode* child);
```

**الوصف**: يزيل عقدة طفل من عقدة أب.

#### `baa_node_get_child`

```c
BaaNode* baa_node_get_child(BaaNode* node, size_t index);
```

**الوصف**: يرجع عقدة طفل بفهرس محدد.

#### `baa_node_count_children`

```c
size_t baa_node_count_children(BaaNode* node);
```

**الوصف**: يرجع عدد العقد الأطفال.

### البحث والتنقل

#### `baa_node_find_by_kind`

```c
BaaNode* baa_node_find_by_kind(BaaNode* root, BaaNodeKind kind);
```

**الوصف**: يبحث عن أول عقدة من نوع محدد.

#### `baa_node_find_all_by_kind`

```c
BaaNodeList* baa_node_find_all_by_kind(BaaNode* root, BaaNodeKind kind);
```

**الوصف**: يبحث عن جميع العقد من نوع محدد.

#### `baa_node_get_parent`

```c
BaaNode* baa_node_get_parent(BaaNode* node);
```

**الوصف**: يرجع العقدة الأب.

#### `baa_node_get_root`

```c
BaaNode* baa_node_get_root(BaaNode* node);
```

**الوصف**: يرجع جذر الشجرة.

### معلومات العقدة

#### `baa_node_get_kind_string`

```c
const char* baa_node_get_kind_string(BaaNodeKind kind);
```

**الوصف**: يحول نوع العقدة إلى نص للتصحيح.

#### `baa_node_get_source_text`

```c
wchar_t* baa_node_get_source_text(BaaNode* node, const wchar_t* source);
```

**الوصف**: يستخرج النص المصدري للعقدة.

### تنظيف الذاكرة

#### `baa_node_destroy`

```c
void baa_node_destroy(BaaNode* node);
```

**الوصف**: ينظف عقدة واحدة دون أطفالها.

#### `baa_node_destroy_recursive`

```c
void baa_node_destroy_recursive(BaaNode* node);
```

**الوصف**: ينظف عقدة وجميع أطفالها تكرارياً.

## دوال الزيارة والاجتياز

### `BaaNodeVisitor`

```c
typedef struct {
    void* user_data;                                    // بيانات المستخدم
    bool (*visit_enter)(BaaNode* node, void* data);     // عند دخول العقدة
    void (*visit_exit)(BaaNode* node, void* data);      // عند الخروج من العقدة
    bool continue_traversal;                            // هل نواصل الاجتياز؟
} BaaNodeVisitor;
```

#### `baa_node_accept_visitor`

```c
void baa_node_accept_visitor(BaaNode* node, BaaNodeVisitor* visitor);
```

**الوصف**: يطبق زائر على عقدة وجميع أطفالها.

#### `baa_node_traverse_preorder`

```c
void baa_node_traverse_preorder(BaaNode* node, 
                                void (*callback)(BaaNode*, void*), 
                                void* user_data);
```

**الوصف**: اجتياز مسبق (الأب قبل الأطفال).

#### `baa_node_traverse_postorder`

```c
void baa_node_traverse_postorder(BaaNode* node, 
                                 void (*callback)(BaaNode*, void*), 
                                 void* user_data);
```

**الوصف**: اجتياز لاحق (الأطفال قبل الأب).

## دوال الطباعة والتصحيح

#### `baa_ast_print`

```c
void baa_ast_print(BaaNode* node, FILE* output);
```

**الوصف**: يطبع الشجرة بتنسيق قابل للقراءة.

#### `baa_ast_print_json`

```c
void baa_ast_print_json(BaaNode* node, FILE* output);
```

**الوصف**: يطبع الشجرة بتنسيق JSON.

#### `baa_ast_print_xml`

```c
void baa_ast_print_xml(BaaNode* node, FILE* output);
```

**الوصف**: يطبع الشجرة بتنسيق XML.

#### `baa_ast_debug_print`

```c
void baa_ast_debug_print(BaaNode* node, int indent_level);
```

**الوصف**: طباعة تفصيلية للتصحيح مع المسافات البادئة.

## دوال التحقق والتحليل

#### `baa_ast_validate`

```c
bool baa_ast_validate(BaaNode* root, BaaDiagnosticList* diagnostics);
```

**الوصف**: يتحقق من صحة الشجرة ويرجع الأخطاء.

#### `baa_ast_get_statistics`

```c
typedef struct {
    size_t total_nodes;             // إجمالي العقد
    size_t expression_nodes;        // عقد التعبيرات
    size_t statement_nodes;         // عقد الجمل
    size_t declaration_nodes;       // عقد الإعلانات
    size_t max_depth;               // أقصى عمق
    size_t function_count;          // عدد الدوال
    size_t variable_count;          // عدد المتغيرات
} BaaAstStatistics;

BaaAstStatistics baa_ast_get_statistics(BaaNode* root);
```

**الوصف**: يحسب إحصائيات الشجرة.

## أمثلة الاستخدام

### مثال إنشاء شجرة بسيطة

```c
#include "baa/ast/ast.h"

// إنشاء تعبير: ١٠ + ٢٠
BaaNode* create_addition_example() {
    BaaSourceLocation loc = {1, 1, 0, "example.baa"};
    
    // إنشاء القيم الحرفية
    BaaNode* left = baa_node_create_literal_int(10, loc);
    BaaNode* right = baa_node_create_literal_int(20, loc);
    
    // إنشاء التعبير الثنائي
    BaaNode* addition = baa_node_create_binary_expr(
        BAA_OPERATOR_ADD, left, right, loc);
    
    return addition;
}
```

### مثال إنشاء دالة

```c
// إنشاء دالة: عدد_صحيح جمع(عدد_صحيح أ، عدد_صحيح ب) { إرجع أ + ب. }
BaaNode* create_function_example() {
    BaaSourceLocation loc = {1, 1, 0, "example.baa"};
    
    // إنشاء معاملات الدالة
    BaaTypeSpecifier int_type = {BAA_TYPE_INT, false, false};
    BaaNode* param_a = baa_node_create_parameter(&int_type, L"أ", loc);
    BaaNode* param_b = baa_node_create_parameter(&int_type, L"ب", loc);
    
    BaaNodeList* params = baa_node_list_create();
    baa_node_list_add(params, param_a);
    baa_node_list_add(params, param_b);
    
    // إنشاء جسم الدالة
    BaaNode* id_a = baa_node_create_identifier(L"أ", loc);
    BaaNode* id_b = baa_node_create_identifier(L"ب", loc);
    BaaNode* addition = baa_node_create_binary_expr(
        BAA_OPERATOR_ADD, id_a, id_b, loc);
    BaaNode* return_stmt = baa_node_create_return_stmt(addition, loc);
    
    BaaNodeList* body_stmts = baa_node_list_create();
    baa_node_list_add(body_stmts, return_stmt);
    BaaNode* body = baa_node_create_block_stmt(body_stmts, loc);
    
    // إنشاء تعريف الدالة
    BaaNode* function = baa_node_create_function_def(
        &int_type, L"جمع", params, body, loc);
    
    return function;
}
```

### مثال اجتياز الشجرة

```c
// دالة تطبع أسماء جميع المعرفات
void print_identifier_names(BaaNode* node, void* data) {
    if (node->kind == BAA_NODE_KIND_IDENTIFIER) {
        printf("معرف: %ls\n", node->data.identifier.name);
    }
}

// استخدام الاجتياز
BaaNode* root = /* شجرة النحو المجردة */;
baa_node_traverse_preorder(root, print_identifier_names, NULL);
```

### مثال زائر متقدم

```c
// زائر لحساب عدد استدعاءات الدوال
typedef struct {
    size_t call_count;
    wchar_t** function_names;
} CallCountVisitor;

bool visit_function_calls(BaaNode* node, void* data) {
    CallCountVisitor* visitor = (CallCountVisitor*)data;
    
    if (node->kind == BAA_NODE_KIND_CALL_EXPR) {
        visitor->call_count++;
        
        // جمع اسم الدالة إذا كان معرف
        if (node->data.call_expr.function->kind == BAA_NODE_KIND_IDENTIFIER) {
            wchar_t* func_name = node->data.call_expr.function->data.identifier.name;
            printf("استدعاء دالة: %ls\n", func_name);
        }
    }
    
    return true; // واصل الاجتياز
}

// الاستخدام
CallCountVisitor call_visitor = {0, NULL};
BaaNodeVisitor visitor = {
    .user_data = &call_visitor,
    .visit_enter = visit_function_calls,
    .visit_exit = NULL,
    .continue_traversal = true
};

baa_node_accept_visitor(root, &visitor);
printf("إجمالي استدعاءات الدوال: %zu\n", call_visitor.call_count);
```

### مثال تحليل وإحصائيات

```c
BaaAstStatistics stats = baa_ast_get_statistics(root);

printf("إحصائيات شجرة النحو المجردة:\n");
printf("إجمالي العقد: %zu\n", stats.total_nodes);
printf("عقد التعبيرات: %zu\n", stats.expression_nodes);
printf("عقد الجمل: %zu\n", stats.statement_nodes);
printf("عقد الإعلانات: %zu\n", stats.declaration_nodes);
printf("أقصى عمق: %zu\n", stats.max_depth);
printf("عدد الدوال: %zu\n", stats.function_count);
printf("عدد المتغيرات: %zu\n", stats.variable_count);
```

## الاختبارات

### اختبارات الوحدة

```bash
# تشغيل اختبارات شجرة النحو المجردة
./build/tests/unit/ast/test_ast_program
./build/tests/unit/ast/test_ast_expressions
./build/tests/unit/ast/test_ast_literals
./build/tests/unit/ast/test_ast_identifiers
```

### أداة اختبار مستقلة

```bash
# استخدام أداة اختبار شجرة النحو المجردة
./build/tools/baa_ast_tester example.baa
```

---

**واجهة شجرة النحو المجردة توفر تمثيل مرن وقوي لبرامج لغة باء مع دعم كامل للتنقل والتحليل والتحويل.**
