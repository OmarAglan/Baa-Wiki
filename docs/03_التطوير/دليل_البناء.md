# دليل البناء لمترجم لغة باء

## المتطلبات المسبقة

### متطلبات النظام الأساسية

#### نظام التشغيل
- **Linux**: Ubuntu 20.04+ أو توزيعات مماثلة
- **macOS**: 10.15+ أو أحدث
- **Windows**: Windows 10/11 مع إدارة الحزم

#### أدوات البناء الأساسية
- **CMake**: الإصدار 3.20 أو أحدث
- **مترجم C**: متوافق مع معيار C11
- **Git**: لاستنساخ المستودع
- **Ninja**: مولد البناء الموصى به (اختياري)

### المترجمات المدعومة

#### Linux
```bash
# GCC (الموصى به)
sudo apt install gcc build-essential cmake ninja-build

# أو Clang
sudo apt install clang build-essential cmake ninja-build
```

#### macOS
```bash
# باستخدام Homebrew
brew install cmake ninja llvm

# أو باستخدام Xcode Command Line Tools
xcode-select --install
```

#### Windows
```powershell
# باستخدام Visual Studio (MSVC)
# تثبيت Visual Studio 2019/2022 مع C++ tools

# أو باستخدام LLVM/Clang
# تحميل وتثبيت LLVM من الموقع الرسمي
```

### المتطلبات الاختيارية

#### دعم LLVM (لتوليد الكود)
```bash
# Linux (Ubuntu/Debian)
sudo apt install llvm-14-dev libllvm14 llvm-14-tools

# macOS
brew install llvm

# Windows
# تحميل LLVM pre-built binaries من الموقع الرسمي
```

## الحصول على الكود المصدري

### استنساخ المستودع

```bash
# استنساخ المستودع الرئيسي
git clone https://github.com/username/baa-language.git
cd baa-language

# التحقق من الفرع الصحيح
git checkout main

# تحديث المودولات الفرعية (إن وجدت)
git submodule update --init --recursive
```

### هيكل المشروع

بعد الاستنساخ، ستحصل على الهيكل التالي:

```
baa-language/
├── CMakeLists.txt          # ملف CMake الرئيسي
├── cmake/                  # ملفات CMake المساعدة
├── src/                    # الكود المصدري
├── include/                # ملفات الرأس
├── tests/                  # الاختبارات
├── tools/                  # أدوات التطوير
└── docs/                   # التوثيق
```

## عملية البناء

### 1. إنشاء دليل البناء

**مهم**: باء يتطلب بناء خارج المصدر (Out-of-source build).

```bash
# إنشاء دليل البناء
mkdir build
cd build
```

### 2. تكوين المشروع

#### Linux/macOS

```bash
# تكوين أساسي مع Ninja
cmake -G "Ninja" ..

# أو مع Make التقليدي
cmake -G "Unix Makefiles" ..

# تكوين مع مترجم محدد
cmake -G "Ninja" -DCMAKE_C_COMPILER=gcc ..
cmake -G "Ninja" -DCMAKE_C_COMPILER=clang ..
```

#### Windows

```powershell
# مع Visual Studio
cmake -G "Visual Studio 16 2019" ..

# مع Ninja و MSVC
cmake -G "Ninja" -DCMAKE_C_COMPILER=cl ..

# مع Clang-cl (من LLVM)
cmake -G "Ninja" -DCMAKE_C_COMPILER="C:/Program Files/LLVM/bin/clang-cl.exe" ..
```

### 3. خيارات التكوين

```bash
# تمكين دعم LLVM
cmake -G "Ninja" -DUSE_LLVM=ON ..

# وضع التصحيح
cmake -G "Ninja" -DCMAKE_BUILD_TYPE=Debug ..

# وضع الإصدار المُحسّن
cmake -G "Ninja" -DCMAKE_BUILD_TYPE=Release ..

# تمكين الاختبارات (افتراضي)
cmake -G "Ninja" -DBUILD_TESTING=ON ..

# تعطيل الاختبارات
cmake -G "Ninja" -DBUILD_TESTING=OFF ..
```

### 4. بناء المشروع

```bash
# بناء المشروع كاملاً
cmake --build .

# بناء هدف محدد
cmake --build . --target baa_compiler

# بناء متوازي (أسرع)
cmake --build . --parallel 4

# بناء مع إخراج مفصل
cmake --build . --verbose
```

## الأهداف المتاحة

### الأهداف الرئيسية

```bash
# المترجم الرئيسي
cmake --build . --target baa_compiler

# مكتبات المكونات
cmake --build . --target baa_preprocessor
cmake --build . --target baa_lexer
cmake --build . --target baa_parser
cmake --build . --target baa_ast

# أدوات الاختبار
cmake --build . --target baa_preprocessor_tester
cmake --build . --target baa_lexer_tester
cmake --build . --target baa_parser_tester
cmake --build . --target baa_ast_tester
```

### الاختبارات

```bash
# بناء جميع الاختبارات
cmake --build . --target all_tests

# تشغيل الاختبارات
ctest

# تشغيل اختبارات محددة
ctest -R lexer
ctest -R parser
ctest -R preprocessor

# تشغيل مع إخراج مفصل
ctest --verbose
```

## تثبيت المترجم

### تثبيت محلي

```bash
# تثبيت في مجلد محدد
cmake --build . --target install

# تحديد مسار التثبيت
cmake -DCMAKE_INSTALL_PREFIX=/usr/local/baa ..
cmake --build . --target install
```

### إنشاء حزمة

```bash
# إنشاء حزمة للتوزيع
cmake --build . --target package

# أنواع الحزم المختلفة
cpack -G TGZ    # Linux tarball
cpack -G ZIP    # Windows zip
cpack -G DEB    # Debian package
cpack -G RPM    # RPM package
```

## اختبار التثبيت

### 1. اختبار الأدوات

```bash
# اختبار المعالج المسبق
./tools/baa_preprocessor_tester ../tests/resources/preprocessor_test_cases/preprocessor_test_all.baa

# اختبار المحلل اللفظي
./tools/baa_lexer_tester ../tests/resources/lexer_test_cases/lexer_test_suite.baa

# اختبار المحلل النحوي
./tools/baa_parser_tester ../tests/resources/parser_tests/valid_simple.baa
```

### 2. برنامج اختبار بسيط

إنشاء ملف `test.baa`:

```baa
// test.baa
#تضمين <stdio>

عدد_صحيح رئيسية() {
    اطبع("مرحباً من لغة باء!").
    إرجع ٠.
}
```

اختبار المراحل:

```bash
# اختبار المعالج المسبق
./tools/baa_preprocessor_tester test.baa

# اختبار المحلل اللفظي
./tools/baa_lexer_tester test.baa

# اختبار المحلل النحوي
./tools/baa_parser_tester test.baa
```

## استكشاف الأخطاء

### مشاكل شائعة في البناء

#### 1. CMake غير موجود أو إصدار قديم

```bash
# التحقق من إصدار CMake
cmake --version

# Linux: تحديث CMake
sudo apt update && sudo apt install cmake

# macOS: تحديث عبر Homebrew
brew upgrade cmake
```

#### 2. مترجم C غير متوافق

```bash
# التحقق من المترجم
gcc --version
clang --version

# تحديد مترجم صراحة
cmake -DCMAKE_C_COMPILER=gcc ..
```

#### 3. مشاكل LLVM (اختياري)

```bash
# تعطيل LLVM إذا كان يسبب مشاكل
cmake -DUSE_LLVM=OFF ..

# تحديد مسار LLVM صراحة
cmake -DLLVM_DIR=/path/to/llvm/lib/cmake/llvm ..
```

#### 4. مشاكل في ترميز الملفات

```bash
# التأكد من ترميز UTF-8
file -bi test.baa
# يجب أن يُظهر: text/plain; charset=utf-8
```

### رسائل خطأ شائعة

#### "Build directory not clean"

```bash
# تنظيف دليل البناء
rm -rf build/*
# أو
cmake --build . --target clean
```

#### "Target not found"

```bash
# عرض جميع الأهداف المتاحة
cmake --build . --target help
```

#### مشاكل ربط LLVM

```bash
# التأكد من تثبيت LLVM development headers
sudo apt install llvm-dev libllvm-dev  # Linux
brew install llvm                      # macOS
```

## تحسين البناء

### 1. بناء متوازي

```bash
# استخدام جميع النوى المتاحة
cmake --build . --parallel $(nproc)

# Windows
cmake --build . --parallel %NUMBER_OF_PROCESSORS%
```

### 2. استخدام ccache (Linux/macOS)

```bash
# تثبيت ccache
sudo apt install ccache  # Linux
brew install ccache       # macOS

# تفعيل ccache
cmake -DCMAKE_C_COMPILER_LAUNCHER=ccache ..
```

### 3. بناء تزايدي

```bash
# بناء المكونات المتغيرة فقط
cmake --build . --target modified_component

# تنظيف جزئي
cmake --build . --target clean_lexer
```

## بناء للتطوير

### 1. وضع التطوير

```bash
# تفعيل جميع التحذيرات والتشخيصات
cmake -DCMAKE_BUILD_TYPE=Debug \
      -DCMAKE_C_FLAGS="-Wall -Wextra -g3 -O0" \
      ..
```

### 2. أدوات التطوير

```bash
# تمكين أدوات إضافية
cmake -DBUILD_DEV_TOOLS=ON ..

# تفعيل تحليل الكود الساكن
cmake -DENABLE_STATIC_ANALYSIS=ON ..
```

### 3. بناء الوثائق

```bash
# بناء وثائق API (يتطلب Doxygen)
cmake --build . --target docs

# بناء دليل المستخدم
cmake --build . --target user_manual
```

## متغيرات البيئة المفيدة

```bash
# تسريع التجميع
export CC=gcc
export CXX=g++
export MAKEFLAGS="-j$(nproc)"

# إعدادات LLVM
export LLVM_DIR=/usr/lib/llvm-14/lib/cmake/llvm

# إعدادات CMake
export CMAKE_BUILD_TYPE=Release
export CMAKE_INSTALL_PREFIX=/usr/local/baa
```

## ملف تكوين مثالي

إنشاء ملف `build.sh` للتكوين السريع:

```bash
#!/bin/bash
# build.sh - سكريبت البناء السريع

# تنظيف البناء السابق
rm -rf build
mkdir build
cd build

# تكوين المشروع
cmake -G "Ninja" \
      -DCMAKE_BUILD_TYPE=Release \
      -DCMAKE_C_COMPILER=gcc \
      -DUSE_LLVM=ON \
      -DBUILD_TESTING=ON \
      ..

# البناء
cmake --build . --parallel $(nproc)

# تشغيل الاختبارات
ctest --output-on-failure

echo "البناء اكتمل بنجاح!"
```

```bash
# جعل السكريبت قابل للتنفيذ
chmod +x build.sh

# تشغيل البناء
./build.sh
```

---

**هذا الدليل يغطي جميع جوانب بناء مترجم لغة باء. للمساعدة الإضافية، راجع [دليل استكشاف الأخطاء](استكشاف_الأخطاء.md) أو افتح قضية في مستودع المشروع.**
