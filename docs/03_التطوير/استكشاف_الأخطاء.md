# دليل استكشاف الأخطاء والتشخيص - لغة باء

## نظرة عامة

يوفر هذا الدليل حلولاً شاملة للمشاكل الشائعة التي قد تواجهها أثناء تطوير وبناء واستخدام مترجم لغة باء. يغطي جميع مراحل التطوير من البناء إلى التشغيل.

## 🏗️ مشاكل البناء والتجميع

### مشاكل CMake

#### "CMake Error: CMAKE_C_COMPILER not found"
```bash
# المشكلة: لم يتم العثور على مترجم C
# الحل: تحديد المترجم صراحة

# Linux
cmake -DCMAKE_C_COMPILER=gcc ..

# macOS
cmake -DCMAKE_C_COMPILER=clang ..

# Windows مع MSVC
cmake -DCMAKE_C_COMPILER=cl ..
```

#### "CMake Error: Could not find LLVM"
```bash
# المشكلة: لم يتم العثور على LLVM
# الحل: تعطيل LLVM أو تثبيته

# تعطيل LLVM (موصى به للمبتدئين)
cmake -DUSE_LLVM=OFF ..

# تثبيت LLVM على Ubuntu
sudo apt install llvm-14-dev libllvm14 llvm-14-tools

# تثبيت LLVM على macOS
brew install llvm
```

#### "Build directory not clean" Error
```bash
# المشكلة: دليل البناء غير نظيف
# الحل: تنظيف وإعادة البناء

cd build
rm -rf *
cmake ..
cmake --build .
```

### مشاكل المترجم

#### "fatal error: baa/lexer.h: No such file or directory"
```bash
# المشكلة: ملفات الرأس غير موجودة
# الحل: التحقق من مسارات التضمين

# التحقق من وجود الملفات
ls -la include/baa/

# إعادة تثبيت الملفات
cmake --build . --target install
```

#### "undefined reference to" Errors
```bash
# المشكلة: مراجع غير معرفة في الربط
# الحل: إعادة بناء جميع المكتبات

# تنظيف وإعادة البناء الكامل
cmake --build . --target clean
cmake --build . --target all
```

#### "Permission denied" on Build
```bash
# المشكلة: صلاحيات غير كافية
# الحل: إصلاح الصلاحيات

# إصلاح صلاحيات دليل البناء
chmod -R u+w build/

# أو إعادة إنشاء دليل البناء
rm -rf build
mkdir build
cd build
```

## 🧪 مشاكل الاختبارات

### اختبارات الوحدة

#### "No tests were found"
```bash
# المشكلة: لم يتم العثور على اختبارات
# الحل: تمكين الاختبارات في CMake

# إعادة التكوين مع الاختبارات
cmake -DBUILD_TESTING=ON ..
cmake --build . --target all_tests
```

#### "Segmentation fault in lexer tests"
```bash
# المشكلة: خطأ في الوصول للذاكرة
# الحل: تشغيل مع valgrind للتشخيص

# تشغيل مع valgrind (Linux)
valgrind --leak-check=full ./tests/unit/lexer/test_lexer

# على Windows، استخدم Visual Studio Debugger
# أو أضف printf للتتبع
```

#### "Test timeout"
```bash
# المشكلة: انتهاء وقت الاختبار
# الحل: تحسين أداء الاختبار أو زيادة المهلة

# تشغيل اختبار واحد مع timeout
timeout 30 ./tests/unit/lexer/test_lexer_arabic
```

### اختبارات التكامل

#### "Parser test file not found"
```bash
# المشكلة: ملف اختبار المحلل النحوي مفقود
# الحل: التحقق من ملفات الاختبار

# سرد ملفات الاختبار
ls -la tests/resources/parser_tests/

# إعادة تنزيل ملفات الاختبار
git checkout HEAD -- tests/resources/
```

#### "AST validation failed"
```bash
# المشكلة: فشل في التحقق من صحة شجرة النحو المجردة
# الحل: تشغيل مع تصحيح مفصل

# تشغيل مع معلومات تصحيح
./tools/baa_parser_tester test.baa --verbose

# أو فحص ملف السجل
tail -f /tmp/baa_parser.log
```

## 🔤 مشاكل اللغة العربية

### مشاكل الترميز

#### "Invalid UTF-8 sequence"
```bash
# المشكلة: تسلسل UTF-8 غير صحيح
# الحل: التحقق من ترميز الملف

# فحص ترميز الملف
file encoding.baa

# تحويل إلى UTF-8
iconv -f windows-1256 -t utf-8 input.baa > output.baa

# على Windows، استخدم Notepad++ للتحويل
```

#### "Arabic characters display as question marks"
```bash
# المشكلة: ظهور علامات استفهام بدلاً من الحروف العربية
# الحل: إعداد الطرفية لدعم UTF-8

# Linux/macOS
export LANG=en_US.UTF-8
export LC_ALL=en_US.UTF-8

# Windows Command Prompt
chcp 65001  # UTF-8 codepage
```

#### "Arabic numbers not recognized"
```bash
# المشكلة: عدم التعرف على الأرقام العربية-الهندية
# الحل: التحقق من إصدار المحلل اللفظي

# اختبار الأرقام العربية
echo "٠ ١ ٢ ٣ ٤ ٥ ٦ ٧ ٨ ٩" | ./tools/baa_lexer_tester

# تحديث إذا لزم الأمر
git pull origin main
```

### مشاكل الكلمات المفتاحية العربية

#### "Undefined keyword" Error
```baa
// المشكلة: كلمة مفتاحية غير معرفة
// الكود الخاطئ:
صحيح رئيسية() {  // يجب أن يكون "عدد_صحيح" بدلاً من "صحيح"
    إرجع ٠.
}

// التصحيح:
عدد_صحيح رئيسية() {
    إرجع ٠.
}
```

#### "Arabic identifier not recognized"
```bash
# المشكلة: معرف عربي غير معترف به
# الحل: فحص قواعد أسماء المعرفات

# قواعد صحيحة:
# - يجب أن يبدأ بحرف (عربي أو إنجليزي)
# - يمكن أن يحتوي على أرقام عربية (٠-٩) أو إنجليزية (0-9)
# - لا يمكن أن يحتوي على مسافات أو رموز خاصة (ماعدا _)

# أمثلة صحيحة:
متغير_عربي
variable_english
متغير123
المتغير_الأول
```

## 🚀 مشاكل التشغيل

### مشاكل المترجم

#### "Command not found" Error
```bash
# المشكلة: أمر المترجم غير موجود
# الحل: التحقق من مسار التثبيت

# إضافة المسار (Linux/macOS)
export PATH=$PATH:/usr/local/bin

# أو تشغيل مباشرة
./build/tools/baa_lexer_tester

# على Windows
set PATH=%PATH%;C:\baa\bin
```

#### "Library not found" Error
```bash
# المشكلة: مكتبة مطلوبة غير موجودة
# الحل: تثبيت المكتبات المطلوبة

# Linux
sudo apt install libutf8proc-dev

# macOS
brew install utf8proc

# أو تعطيل الميزة
cmake -DUSE_UTF8PROC=OFF ..
```

#### "Stack overflow in parser"
```bash
# المشكلة: تجاوز سعة المكدس في المحلل النحوي
# الحل: زيادة حجم المكدس أو تبسيط التعبير

# Linux
ulimit -s 65536  # 64MB stack

# أو تحسين الكود لتجنب التكرار العميق
```

### مشاكل الأداء

#### "Compilation too slow"
```bash
# المشكلة: التجميع بطيء جداً
# الحل: تحسين إعدادات البناء

# استخدام بناء متوازي
cmake --build . --parallel $(nproc)

# استخدام ccache (إذا متوفر)
cmake -DCMAKE_C_COMPILER_LAUNCHER=ccache ..

# بناء وضع الإصدار فقط
cmake -DCMAKE_BUILD_TYPE=Release ..
```

#### "Memory usage too high"
```bash
# المشكلة: استخدام ذاكرة عالي
# الحل: مراقبة استخدام الذاكرة وتحسينه

# مراقبة مع valgrind (Linux)
valgrind --tool=massif ./program

# أو استخدام أدوات النظام
top -p $(pidof program)

# تحسين: تقليل حجم المخازن المؤقتة أو استخدام تخصيص ديناميكي أفضل
```

## 🐛 مشاكل التصحيح

### تصحيح المحلل اللفظي

#### "Unexpected token" Error
```c
// إضافة تصحيح للمحلل اللفظي
void debug_token(BaaToken token) {
    printf("Token: %s at line %d, column %d\n",
           baa_token_kind_to_string(token.kind),
           token.location.line,
           token.location.column);
    
    if (token.lexeme) {
        printf("Lexeme: %ls\n", token.lexeme);
    }
}

// في الكود الرئيسي:
BaaToken token = baa_lexer_next_token(lexer);
debug_token(token);  // للتصحيح
```

#### "Infinite loop in lexer"
```c
// إضافة عداد للوقاية من الحلقة اللانهائية
int token_count = 0;
const int MAX_TOKENS = 10000;

while (token.kind != BAA_TOKEN_EOF && token_count < MAX_TOKENS) {
    // معالجة الرمز
    token = baa_lexer_next_token(lexer);
    token_count++;
    
    if (token_count >= MAX_TOKENS) {
        fprintf(stderr, "Lexer infinite loop detected\n");
        break;
    }
}
```

### تصحيح المحلل النحوي

#### "Parser stuck" Issue
```c
// إضافة معلومات تصحيح للمحلل النحوي
void debug_parser_state(BaaParser* parser) {
    BaaToken current = baa_parser_current_token(parser);
    printf("Parser state: Line %d, Col %d, Token: %s\n",
           current.location.line,
           current.location.column,
           baa_token_kind_to_string(current.kind));
}

// في دالة التحليل:
debug_parser_state(parser);
if (!baa_parser_expect_token(parser, expected_kind)) {
    // معالجة الخطأ مع معلومات مفيدة
}
```

#### "Memory leak in AST"
```c
// استخدام valgrind للكشف عن تسريب الذاكرة
valgrind --leak-check=full --show-leak-kinds=all ./program

// أو إضافة عداد للعقد
static int node_count = 0;

BaaNode* baa_node_create(BaaNodeKind kind) {
    node_count++;
    // ... باقي الكود
    
    if (node_count > 10000) {
        fprintf(stderr, "Warning: Many nodes created (%d)\n", node_count);
    }
}
```

## 📊 مشاكل التحليل الدلالي

### مشاكل جداول الرموز

#### "Symbol not found"
```c
// إضافة تصحيح لجداول الرموز
void debug_symbol_table(SymbolTable* table) {
    printf("Symbol table contents:\n");
    for (int i = 0; i < table->count; i++) {
        Symbol* sym = &table->symbols[i];
        printf("  %s: %s (line %d)\n",
               sym->name, symbol_kind_to_string(sym->kind),
               sym->declaration_line);
    }
}

// في محلل الأسماء:
Symbol* sym = symbol_table_lookup(table, name);
if (!sym) {
    debug_symbol_table(table);
    fprintf(stderr, "Symbol '%s' not found\n", name);
}
```

#### "Variable redeclaration"
```c
// تحسين رسائل خطأ إعادة التعريف
void report_redeclaration(const char* name, int old_line, int new_line) {
    fprintf(stderr, "Error: Variable '%s' redeclared\n", name);
    fprintf(stderr, "  First declaration at line %d\n", old_line);
    fprintf(stderr, "  Second declaration at line %d\n", new_line);
    fprintf(stderr, "  Consider using different names or scopes\n");
}
```

## 🔧 مشاكل النظام البيئي

### مشاكل IDE وأدوات التطوير

#### "Syntax highlighting not working"
```json
// إعدادات VSCode للغة باء
{
    "files.associations": {
        "*.ب": "c"
    },
    "editor.defaultFormatter": "ms-vscode.cpptools"
}
```

#### "IntelliSense not recognizing Baa files"
```json
// إضافة دعم ملفات باء
{
    "C_Cpp.files.associations": {
        "*.ب": "c"
    },
    "C_Cpp.default.includePath": [
        "${workspaceFolder}/include"
    ]
}
```

### مشاكل نظام التحكم في الإصدارات

#### "Git encoding issues"
```bash
# إعداد Git لدعم UTF-8
git config core.autocrlf false
git config core.safecrlf false
git config core.eol lf

# إعادة إضافة الملفات
git rm --cached -r .
git reset --hard
```

#### "Merge conflicts in documentation"
```bash
# حل تعارضات الدمج في التوثيق
git mergetool  # استخدام أداة الدمج

# أو يدوياً:
# 1. افتح الملف المتعارض
# 2. ابحث عن <<<<<<< HEAD
# 3. اختر الإصدار المناسب أو ادمج الاثنين
# 4. احذف علامات التعارض
# 5. احفظ الملف
```

## 📈 تحسينات الأداء

### تحسين أداء المترجم

#### "Slow compilation"
```bash
# استخدام ccache لتسريع إعادة التجميع
sudo apt install ccache
cmake -DCMAKE_C_COMPILER_LAUNCHER=ccache ..

# أو distcc للتجميع الموزع
sudo apt install distcc
export CC="distcc gcc"
```

#### "High memory usage"
```c
// تحسين إدارة الذاكرة في الكود
#define INITIAL_CAPACITY 64
#define GROWTH_FACTOR 2

// بدلاً من realloc في كل مرة، استخدم نمو ذكي
if (array->count >= array->capacity) {
    size_t new_capacity = array->capacity * GROWTH_FACTOR;
    array->data = realloc(array->data, new_capacity * sizeof(Item));
    array->capacity = new_capacity;
}
```

## 🎯 نصائح للتشخيص الفعال

### منهجية التشخيص

1. **إعادة إنتاج المشكلة**
   - حدد الخطوات المطلوبة لإعادة إنتاج المشكلة
   - أنشئ حالة اختبار بسيطة

2. **جمع المعلومات**
   - إصدار النظام والأدوات
   - رسائل الخطأ الكاملة
   - ملفات السجل إن وجدت

3. **الاختبار الثنائي**
   - جرب مع إصدارات مختلفة
   - اختبر على أنظمة مختلفة
   - عزل المشكلة إلى مكون واحد

4. **الحل والاختبار**
   - طبق الحل المقترح
   - اختبر مع حالات متعددة
   - تأكد من عدم كسر أي شيء آخر

### أدوات التشخيص المفيدة

#### Linux/macOS
```bash
# مراقبة العمليات
top
htop

# تحليل الأداء
perf
strace

# فحص الذاكرة
valgrind --leak-check=full program
valgrind --tool=cachegrind program

# تتبع النظام
ltrace program
strace program
```

#### Windows
```cmd
# مراقبة المهام
taskmgr

# أدوات المطور
Visual Studio Performance Profiler
Process Monitor
```

### إنشاء تقرير خطأ مفيد

```markdown
## تقرير خطأ مفصل

### معلومات النظام
- نظام التشغيل: [Windows/Linux/macOS] [الإصدار]
- مترجم C: [GCC/Clang/MSVC] [الإصدار]
- إصدار باء: [الإصدار أو commit hash]
- إصدار CMake: [الإصدار]

### وصف المشكلة
[وصف واضح ومختصر للمشكلة]

### خطوات الإعادة إنتاج
1. [الخطوة الأولى]
2. [الخطوة الثانية]
3. [إلخ...]

### السلوك المتوقع
[ما كان يجب أن يحدث]

### السلوك الفعلي
[ما حدث فعلاً]

### ملفات السجل أو رسائل الخطأ
```
[لصق الرسائل هنا]
```

### محاولات الحل
[ما جربت فعله لإصلاح المشكلة]

### ملفات إضافية
[أي ملفات أو لقطات شاشة ذات صلة]
```

## 🚨 الحالات الطارئة

### "System completely broken"
```bash
# إعادة تعيين كاملة للمشروع
cd /path/to/project

# حفظ العمل الحالي (إن أمكن)
git stash

# إعادة تنزيل المشروع
git fetch origin
git reset --hard origin/main

# إعادة بناء من الصفر
rm -rf build/
mkdir build && cd build
cmake ..
cmake --build .
```

### "Data corruption"
```bash
# فحص سلامة الملفات
find . -name "*.c" -exec gcc -fsyntax-only {} \;

# فحص ملفات الترميز
find . -name "*.md" -exec file {} \;

# إصلاح ملفات UTF-8 تالفة
for file in $(find . -name "*.md"); do
    if ! iconv -f utf-8 -t utf-8 "$file" > /dev/null 2>&1; then
        echo "Fixing $file"
        # محاولة الإصلاح أو الإبلاغ
    fi
done
```

---

**هذا الدليل يغطي معظم المشاكل الشائعة التي قد تواجهها. إذا واجهت مشكلة غير مدرجة هنا، يرجى الإبلاغ عنها في مستودع المشروع مع تقرير خطأ مفصل.**

*آخر تحديث: 2025-01-09*
