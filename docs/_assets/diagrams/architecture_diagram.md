# معمارية مترجم لغة باء

## نظرة عامة على المعمارية

```
┌─────────────────────────────────────────────────────────────────┐
│                           مستخدم                                │
└─────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────┐
│                        مترجم لغة باء                           │
│                                                                 │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐           │
│  │ معالج       │  │ محلل       │  │ محلل       │  ┌─────────┐ │
│  │ مسبق        │→│ لفظي       │→│ نحوي       │→│ شجرة     │ │
│  │             │  │             │  │             │  │ النحو    │ │
│  └─────────────┘  └─────────────┘  └─────────────┘  │ المجردة │ │
│                                                     │         │ │
│                                                     └─────────┘ │
│                                                                 │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐           │
│  │ تحليل       │  │ توليد       │  │ تحسين       │           │
│  │ دلالي       │  │ الكود       │  │ الكود       │           │
│  │ (مخطط)      │  │ (مخطط)      │  │ (مخطط)      │           │
│  └─────────────┘  └─────────────┘  └─────────────┘           │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────┐
│                          كود الهدف                              │
└─────────────────────────────────────────────────────────────────┘
```

## مراحل المعالجة

### 1. مرحلة المعالجة المسبقة

```
ملف المصدر (.ب)
       │
       ▼
┌─────────────┐
│  معالج      │
│  مسبق       │
└─────────────┘
       │
       ▼
تدفق UTF-16LE معالج
```

**الوظائف:**
- تضمين الملفات (`#تضمين`)
- تعريف الماكروات (`#تعريف`)
- التجميع الشرطي (`#إذا`)
- كشف ترميز الملفات

### 2. مرحلة التحليل اللفظي

```
تدفق UTF-16LE
       │
       ▼
┌─────────────┐
│  محلل      │
│  لفظي       │
└─────────────┘
       │
       ▼
   تدفق الرموز
```

**الوظائف:**
- تحليل الكلمات المفتاحية العربية
- معالجة الأرقام العربية-الهندية
- تطبيق تسلسلات الهروب العربية
- إنشاء رموز مع معلومات الموقع

### 3. مرحلة التحليل النحوي

```
تدفق الرموز
       │
       ▼
┌─────────────┐
│  محلل      │
│  نحوي       │
└─────────────┘
       │
       ▼
شجرة النحو المجردة
```

**الوظائف:**
- تحليل الصيغة النحوية
- بناء شجرة النحو المجردة
- معالجة الأخطاء واستردادها
- تطبيق أولوية العمليات

### 4. مرحلة التحليل الدلالي (مخطط)

```
شجرة النحو المجردة
       │
       ▼
┌─────────────┐
│  محلل      │
│  دلالي      │
└─────────────┘
       │
       ▼
شجرة محققة
```

**الوظائف المخططة:**
- فحص الأنواع
- حل الأسماء
- فحص التدفق
- تحليل النطاق

### 5. مرحلة توليد الكود (مخطط)

```
شجرة محققة
       │
       ▼
┌─────────────┐
│  مولد      │
│  الكود      │
└─────────────┘
       │
       ▼
 كود LLVM IR
```

**الوظائف المخططة:**
- توليد LLVM IR
- تحسين الكود
- دعم منصات متعددة
- معلومات التصحيح

## هيكل المكونات الداخلي

### مكونات المترجم الأساسية

```
baa_compiler/
├── preprocessor/           # معالج مسبق كامل
├── lexer/                  # محلل لفظي مع دعم عربي
├── parser/                 # محلل نحوي مع استرداد أخطاء
├── ast/                    # شجرة نحو مجردة موحدة
├── types/                  # نظام أنواع أساسي
├── operators/              # تعريفات العمليات
└── utils/                  # أدوات مساعدة
```

### أدوات التطوير

```
tools/
├── baa_preprocessor_tester # اختبار المعالج المسبق
├── baa_lexer_tester        # اختبار المحلل اللفظي
├── baa_parser_tester       # اختبار المحلل النحوي
└── baa_ast_tester          # اختبار شجرة النحو المجردة
```

## تدفق البيانات

### تدفق المعالجة الرئيسي

```
ملف مصدر → معالج مسبق → محلل لفظي → محلل نحوي → AST → تحليل دلالي → توليد كود → كود قابل للتنفيذ
     ↓           ↓             ↓            ↓       ↓         ↓              ↓            ↓
   UTF-8    تدفق UTF-16LE    تدفق رموز    شجرة AST  شجرة محققة    LLVM IR    كود أصلي
```

### تدفق المعلومات العكسي (للأخطاء)

```
رسالة خطأ ← موقع المصدر ← معلومات الرمز ← موقع الرمز ← موقع الأصلي
```

## واجهات المكونات

### واجهة المعالج المسبق

```c
// معالجة ملف واحد
BaaPreprocessorResult baa_preprocess_file(const char* filename);

// معالجة نص
BaaPreprocessorResult baa_preprocess_string(const char* source, size_t length);

// الحصول على الإخراج
const wchar_t* baa_preprocessor_get_output(BaaPreprocessorResult result);
size_t baa_preprocessor_get_output_length(BaaPreprocessorResult result);
```

### واجهة المحلل اللفظي

```c
// إنشاء محلل لفظي
BaaLexer* baa_lexer_create(const wchar_t* input, size_t input_length);

// الحصول على الرمز التالي
BaaToken baa_lexer_next_token(BaaLexer* lexer);

// معلومات الرمز
BaaTokenKind baa_token_get_kind(BaaToken token);
const wchar_t* baa_token_get_lexeme(BaaToken token);
BaaSourceLocation baa_token_get_location(BaaToken token);
```

### واجهة المحلل النحوي

```c
// إنشاء محلل نحوي
BaaParser* baa_parser_create(BaaLexer* lexer, const BaaParseOptions* options);

// تحليل البرنامج
BaaParseResult baa_parser_parse_program(BaaParser* parser);

// تحليل تعبيرات فرعية
BaaParseResult baa_parser_parse_expression(BaaParser* parser);
BaaParseResult baa_parser_parse_statement(BaaParser* parser);
```

### واجهة شجرة النحو المجردة

```c
// إنشاء عقد
BaaNode* baa_node_create_literal_int(long long value, BaaSourceLocation location);
BaaNode* baa_node_create_binary_expr(BaaOperatorKind op, BaaNode* left, BaaNode* right);

// إدارة الشجرة
void baa_node_add_child(BaaNode* parent, BaaNode* child);
BaaNode* baa_node_get_child(BaaNode* node, size_t index);

// الاجتياز
void baa_node_traverse_preorder(BaaNode* node, BaaNodeVisitor* visitor);
```

## نظام إدارة الأخطاء

### مستويات الأخطاء

```
┌─────────────────────────────────────────────────────────────────┐
│                          مستخدم                                │
└─────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────┐
│                      نظام التشخيص                              │
│                                                                 │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐           │
│  │ خطأ      │  │ تحذير     │  │ ملاحظة    │           │
│  │ (Error)      │  │ (Warning)    │  │ (Note)      │           │
│  │             │  │              │  │             │           │
│  │ توقف       │  │ يستمر      │  │ معلومات   │           │
│  │ التنفيذ     │  │ التنفيذ      │  │ إضافية     │           │
│  └─────────────┘  └─────────────┘  └─────────────┘           │
└─────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────┐
│                      تقرير الأخطاء                            │
│  • موقع المصدر                                                  │
│  • سياق المشكلة                                                 │
│  • اقتراحات الإصلاح                                             │
│  • معلومات إضافية                                              │
└─────────────────────────────────────────────────────────────────┘
```

### تدفق معالجة الأخطاء

```
خطأ في الكود ← تحديد الموقع ← تصنيف الخطأ ← إضافة السياق ← تقرير للمستخدم
```

## التوسع والامتداد

### نقاط التوسع المخططة

```
النواة الحالية
├── معالج مسبق كامل
├── محلل لفظي مع دعم عربي
├── محلل نحوي مع استرداد أخطاء
└── شجرة نحو مجردة موحدة

نقاط التوسع
├── تحليل دلالي (مخطط)
├── توليد كود LLVM (مخطط)
├── مكتبة قياسية (مخطط)
└── أدوات تطوير متقدمة (مخطط)
```

### واجهات التوسع

```c
// واجهة التحليل الدلالي (مخطط)
typedef struct BaaSemanticAnalyzer BaaSemanticAnalyzer;
BaaSemanticAnalyzer* baa_semantic_analyzer_create(void);
void baa_semantic_analyze(BaaSemanticAnalyzer* analyzer, BaaNode* ast);

// واجهة توليد الكود (مخطط)
typedef struct BaaCodeGenerator BaaCodeGenerator;
BaaCodeGenerator* baa_code_generator_create(void);
void baa_generate_code(BaaCodeGenerator* generator, BaaNode* ast, const char* output_file);
```

## ملخص المعمارية

### المبادئ المعمارية

1. **الوضوح**: كود واضح وقابل للقراءة
2. **القابلية للصيانة**: واجهات محددة بوضوح
3. **دعم العربية**: تكامل أصيل في جميع المستويات
4. **الأداء**: تحسينات مناسبة بدون تعقيد مفرط
5. **القابلية للاختبار**: كل مكون قابل للاختبار بشكل منفصل
6. **الاسترداد من الأخطاء**: معالجة أخطاء قوية مع استمرارية العمل

### المزايا الرئيسية

- **معالجة شاملة للنصوص العربية** مع دعم كامل للترميز
- **نظام تشخيص متقدم** مع معلومات موقع دقيقة
- **معمارية معيارية** سهلة الفهم والتوسع
- **فصل واضح بين المكونات** مع واجهات محددة
- **دعم تطويري قوي** مع أدوات اختبار شاملة

### التحديات المعمارية المحلولة

1. **دعم النص العربي**: تم حل مع معالجة UTF-16LE شاملة
2. **معالجة الأخطاء**: تم حل مع نظام تشخيص متعدد المستويات
3. **استرداد من الأخطاء**: تم حل مع استراتيجيات استرداد ذكية
4. **الأداء**: تم حل مع تحسينات مستهدفة
5. **القابلية للصيانة**: تم حل مع فصل واضح للمسؤوليات

---

**معمارية مترجم لغة باء مصممة لتكون قوية وقابلة للصيانة مع دعم أصيل للغة العربية في جميع المستويات.**
